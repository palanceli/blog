---
layout: post
title: åˆ›ä¸–è®°ï¼ˆä¸€ï¼‰â€”â€”Zygoteè¿›ç¨‹çš„å¯åŠ¨
date: 2017-01-27 22:57:29 +0800
categories: Androidå­¦ä¹ ç¬”è®°
tags: Zygoteè¿›ç¨‹
toc: true
comments: true
---
Androidç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯initï¼Œå®ƒå°†Zygoteè¿›ç¨‹å¯åŠ¨èµ·æ¥ï¼Œæ‰€æœ‰åº”ç”¨ç¨‹åºè¿›ç¨‹ä»¥åŠè¿è¡Œç³»ç»Ÿå…³é”®æœåŠ¡çš„Systemè¿›ç¨‹ç”±Zygoteè´Ÿè´£åˆ›å»ºã€‚<!-- more -->

# Step1 init.rcè„šæœ¬
initå¯åŠ¨åä¼šæ ¹æ®init.rcåˆ›å»ºZygoteè¿›ç¨‹ï¼Œinit.rcå†…å®¹å¦‚ä¸‹ï¼š
```
// system/core/rootdir/init.rc
...
import /init.environ.rc
import /init.usb.rc
import /init.${ro.hardware}.rc
import /init.usb.configfs.rc
import /init.${ro.zygote}.rc
import /init.trace.rc
...

```
Android 5.0å¼€å§‹æ”¯æŒ64ä½ç¨‹åºï¼Œæ‰€ä»¥åœ¨init.rcä¸­æ ¹æ®ç³»ç»Ÿæƒ…å†µå¼•å…¥ä¸åŒè„šæœ¬ã€‚åœ¨system/core/rootdirä¸‹ï¼Œzygoteæœ‰å››ä¸ªé…ç½®ï¼š

è„šæœ¬åç§°|è¯´æ˜
---|----
init.zygote32.rc|çº¯32ä½æ¨¡å¼ï¼Œzygoteè¿›ç¨‹å¯¹åº”app_process
init.zygote32_64.rc|çº¯64ä½æ¨¡å¼ï¼Œzygoteè¿›ç¨‹å¯¹åº”app_process64
init.zygote64.rc|å¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹(zygoteå’Œzygote_secondary)åˆ†åˆ«å¯¹åº”app_process32ï¼ˆä¸»æ¨¡å¼ï¼‰å’Œapp_process64
init.zygote64_32.rc|å¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹(zygoteå’Œzygote_secondary)åˆ†åˆ«å¯¹åº”app_process64(ä¸»æ¨¡å¼)å’Œapp_process32

# Step2 init.zygote32.rc
æ¥çœ‹init.zygote32.rcï¼š
```
service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    class main
    socket zygote stream 660 root system
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart media
    onrestart restart netd
    writepid /dev/cpuset/foreground/tasks
```
è„šæœ¬æ ¼å¼è¯´æ˜å¯å‚è§system/core/init/readme.txtã€‚
serviceæ˜¯ç”±initå¯åŠ¨çš„ç¨‹åºï¼Œå½¢å¼å¦‚ä¸‹ï¼š
```
service <name> <pathname> [ <argument> ]*
   <option>
   <option>
   ...
```
optionç”¨äºä¿®é¥°serviceï¼Œä»–ä»¬ä¼šå½±å“åˆ°initå¯åŠ¨serviceçš„æ—¶æœºå’Œæ–¹å¼ã€‚ç›¸å…³çš„optionç±»æ ¼å¼è¯´æ˜ï¼š
```
socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]
  åˆ›å»ºä¸€ä¸ªåå­—ä¸º/dev/socket/<name>çš„å¥—æ¥å­—ï¼Œå¹¶æŠŠæè¿°ç¬¦ä¼ ç»™è¿›ç¨‹ã€‚<type>å¿…å–"dgram"ã€"stream"æˆ–"seqpacket"ä¹‹ä¸€ã€‚<user>ã€<group>é»˜è®¤ä¸º0.<seclable>æ˜¯å¥—æ¥å­—çš„SELinuxå®‰å…¨ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤ä¸ºserviceçš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…ç”±seclableæŒ‡å®šï¼Œæˆ–è€…åŸºäºserviceå¯æ‰§è¡Œæ–‡ä»¶çš„å®‰å…¨ä¸Šä¸‹æ–‡è®¡ç®—å¾—å‡ºã€‚å…¶ä¸­permçš„æ¯ä¸ªæ•°å­—æ˜¯ç”±w=4,r=2,x=1ç»„åˆè€Œæˆï¼Œä¸‰ä¸ªæ•°å­—åˆ†åˆ«ç”¨äºå®šä¹‰ownerã€groupã€otherçš„æƒé™ã€‚

class <name>
  æŒ‡å®šæœåŠ¡æ‰€åœ¨ç±»åï¼Œä»¥ä¾¿ç›¸åŒç±»åçš„æœåŠ¡å¯ä»¥ä¸€èµ·å¯åŠ¨å’Œåœæ­¢ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º"default"ã€‚

onrestart
  é‡å¯æ—¶æ‰§è¡Œä¸€æ¡å‘½ä»¤ã€‚

writepid <file...>
  æ‰§è¡Œforkæ—¶ï¼ŒæŠŠå­è¿›ç¨‹idå†™å…¥æŒ‡å®šæ–‡ä»¶ã€‚
```
å› æ­¤å†æ¥è§£è¯»init.zygote32.rcæ–‡ä»¶ï¼Œå®ƒå®šä¹‰äº†åç§°ä¸ºzygoteçš„æœåŠ¡ï¼Œè¯¥æœåŠ¡æ‰§è¡Œæ–‡ä»¶`/syste/bin/app_process`å‚æ•°ä¸ºï¼š`-Xzygote /system/bin --zygote --start-system-server`ã€‚å®ƒåˆ›å»ºçš„socketå¯¹äºownerå’Œgroupå‡ä¸ºå¯è¯»å†™ã€‚

# Step3 service_start(...)
``` c++
// system/core/init/init.cpp:187
void service_start(struct service *svc, const char *dynamic_args)
{
    ...
    pid_t pid = fork();  // å½“å‰è¿›ç¨‹ä¸ºinit
    if (pid == 0) {      // åœ¨å­è¿›ç¨‹ï¼ˆå³Zygoteè¿›ç¨‹ï¼‰ä¸­è¿”å›
        struct socketinfo *si;
        ...
        // svn->socketså³åœ¨init.zygote*.rcä¸­çš„socketéƒ¨åˆ†
        // éå†è¯¥éƒ¨åˆ†çš„æ‰€æœ‰socketé…ç½®ï¼Œå¹¶åˆ›å»º
        for (si = svc->sockets; si; si = si->next) {
            int socket_type = (
                    !strcmp(si->type, "stream") ? SOCK_STREAM :
                        (!strcmp(si->type, "dgram") ? SOCK_DGRAM : SOCK_SEQPACKET));
            // ğŸ Step4
            int s = create_socket(si->name, socket_type,
                                  si->perm, si->uid, si->gid, si->socketcon ?: scon);
            if (s >= 0) {
                publish_socket(si->name, s); // ğŸ Step5
            }
        }

        ...
        // dynamic_argsæ˜¯è¯¥æœåŠ¡çš„åŠ¨æ€å¯åŠ¨å‚æ•°åˆ—è¡¨
        if (!dynamic_args) {
            // svn->args[0] = "/system/bin/app_process"
            // å¦‚æœæ²¡æœ‰åŠ¨æ€å¯åŠ¨å‚æ•°åˆ—è¡¨ï¼Œåˆ™ç›´æ¥æ‰§è¡Œinit.zygote*.rcä¸­çš„å‘½ä»¤
            if (execve(svc->args[0], (char**) svc->args, (char**) ENV) < 0) {
                ...
            }
        } else { // å¦åˆ™æŠŠåŠ¨æ€å‚æ•°å’Œé™æ€å‚æ•°åˆå¹¶åˆ°arg_ptrsä¸­å†æ‰§è¡Œserviceå‘½ä»¤
            char *arg_ptrs[INIT_PARSER_MAXARGS+1];
            int arg_idx = svc->nargs;
            char *tmp = strdup(dynamic_args);
            char *next = tmp;
            char *bword;

            /* Copy the static arguments */
            memcpy(arg_ptrs, svc->args, (svc->nargs * sizeof(char *)));

            while((bword = strsep(&next, " "))) {
                arg_ptrs[arg_idx++] = bword;
                if (arg_idx == INIT_PARSER_MAXARGS)
                    break;
            }
            arg_ptrs[arg_idx] = NULL;
            execve(svc->args[0], (char**) arg_ptrs, (char**) ENV);
        }
        _exit(127);
    }
    ...
}
```
# Step4 create_socket(...)
``` c++
// system/core/init/util.cpp:91
int create_socket(const char *name, int type, mode_t perm, uid_t uid,
                  gid_t gid, const char *socketcon)
{
    // name = "zygote"
    // æŒ‰ç…§init.zygote*.rcä¸­çš„é…ç½®åˆ›å»ºsocketï¼Œå¹¶è¿”å›æè¿°ç¬¦
    struct sockaddr_un addr;
    int fd, ret;
    ...
    fd = socket(PF_UNIX, type, 0);
    ...
    memset(&addr, 0 , sizeof(addr));
    addr.sun_family = AF_UNIX;
    // ANDROID_SOCKET_DIRä¸º"/dev/socket" 
    // addr.sun_path ä¸º"/dev/socket/zygote"
    snprintf(addr.sun_path, sizeof(addr.sun_path), ANDROID_SOCKET_DIR"/%s",
             name);
    ...
    ret = bind(fd, (struct sockaddr *) &addr, sizeof (addr));
    ...
    // permä¸º660ï¼Œå¯¹äºownerå’Œgroupå‡ä¸ºå¯è¯»å†™
    chown(addr.sun_path, uid, gid);
    chmod(addr.sun_path, perm);
    ...
    return fd;
    ...
}
```
# Step5 publish_socket(...)
``` c++
// system/core/init/init.cpp:172
static void publish_socket(const char *name, int fd)
{
    char key[64] = ANDROID_SOCKET_ENV_PREFIX; // "ANDROID_SOCKET_"
    char val[64];

    // key = "ANDROID_SOCKET_zygote"
    strlcpy(key + sizeof(ANDROID_SOCKET_ENV_PREFIX) - 1,
            name,
            sizeof(key) - sizeof(ANDROID_SOCKET_ENV_PREFIX));
    snprintf(val, sizeof(val), "%d", fd);
    add_environment(key, val); // æŠŠæè¿°ç¬¦å†™å…¥ç¯å¢ƒå˜é‡"ANDROID_SOCKET_zygote"

    /* make sure we don't close-on-exec */
    fcntl(fd, F_SETFD, 0);
}
```
ç»¼ä¸Šæ‰€è¿°ï¼Œè¿›ç¨‹initæ ¹æ®é…ç½®æ–‡ä»¶`init.zygote*.rc`ï¼š
* é¦–å…ˆåˆ›å»ºsocketï¼Œå¹¶å°†å…¶æè¿°ç¬¦å†™å…¥ç¯å¢ƒå˜é‡ï¼›
* ç„¶åæ‰¾åˆ°zygoteå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶å¯åŠ¨è¿›ç¨‹ã€‚

æ¥ä¸‹æ¥æ‰¾åˆ°system/bin/app_processçš„å…¥å£å‡½æ•°ã€‚

# Step6 app_process::main(...)
``` c
// frameworks/base/cmds/app_process/app_main.cpp:186
int main(int argc, char* const argv[])
{
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) < 0) {...}

    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));
    // Process command line arguments
    // ignore argv[0]
    argc--;
    argv++;

    // Everything up to '--' or first non '-' arg goes to the vm.
    //
    // The first argument after the VM args is the "parent dir", which
    // is currently unused.
    //
    // After the parent dir, we expect one or more the following internal
    // arguments :
    //
    // --zygote : Start in zygote mode
    // --start-system-server : Start the system server.
    // --application : Start in application (stand alone, non zygote) mode.
    // --nice-name : The nice name for this process.
    //
    // For non zygote starts, these arguments will be followed by
    // the main class name. All remaining arguments are passed to
    // the main method of this class.
    //
    // For zygote starts, all remaining arguments are passed to the zygote.
    // main function.
    //
    // Note that we must copy argument string values since we will rewrite the
    // entire argument block when we apply the nice name to argv0.

    int i;
    for (i = 0; i < argc; i++) {
        if (argv[i][0] != '-') {
            break;
        }
        if (argv[i][1] == '-' && argv[i][2] == 0) {
            ++i; // Skip --.
            break;
        }
        runtime.addOption(strdup(argv[i]));
    }

    // Parse runtime arguments.  Stop at first unrecognized option.
    bool zygote = false;
    bool startSystemServer = false;
    bool application = false;
    String8 niceName;
    String8 className;

    ++i;  // Skip unused "parent dir" argument.
    while (i < argc) {
        const char* arg = argv[i++];
        if (strcmp(arg, "--zygote") == 0) {
            zygote = true; // ç”±init.zygote*.rcå¯çŸ¥è¯¥å€¼ä¸ºtrue
            niceName = ZYGOTE_NICE_NAME; // "zygote"
        } else if (strcmp(arg, "--start-system-server") == 0) {
            startSystemServer = true;
        } else if (strcmp(arg, "--application") == 0) {
            application = true;
        } else if (strncmp(arg, "--nice-name=", 12) == 0) {
            niceName.setTo(arg + 12);
        } else if (strncmp(arg, "--", 2) != 0) {
            className.setTo(arg);
            break;
        } else {
            --i;
            break;
        }
    }

    Vector<String8> args;
    if (!className.isEmpty()) { // className ä¸ºç©º
        // We're not in zygote mode, the only argument we need to pass
        // to RuntimeInit is the application argument.
        //
        // The Remainder of args get passed to startup class main(). Make
        // copies of them before we overwrite them with the process name.
        args.add(application ? String8("application") : String8("tool"));
        runtime.setClassNameAndArgs(className, argc - i, argv + i);
    } else {
        // We're in zygote mode.
        maybeCreateDalvikCache();

        if (startSystemServer) {
            args.add(String8("start-system-server"));
        }

        char prop[PROP_VALUE_MAX];
        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) {...}

        String8 abiFlag("--abi-list=");
        abiFlag.append(prop);
        args.add(abiFlag);

        // In zygote mode, pass all remaining arguments to the zygote
        // main() method.
        for (; i < argc; ++i) {
            args.add(String8(argv[i]));
        }
    }

    if (!niceName.isEmpty()) { // niceName = "zygote"
        runtime.setArgv0(niceName.string());
        set_process_name(niceName.string()); // è¿›ç¨‹åè®¾ç½®ä¸º"zygote"
    }

    if (zygote) { // zygote = true
        // ğŸ
        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);
    } else ...
}
```
# Step7 AppRuntime::start(...)
``` c++
// frameworks/base/core/jni/AndroidRuntime.cpp:1007
void AndroidRuntime::start(const char* className, const Vector<String8>& options, bool zygote)
{
    // className = "com.android.internal.os.ZygoteInit"
    // zygote = true
    ...
    const char* rootDir = getenv("ANDROID_ROOT");
    if (rootDir == NULL) {
        rootDir = "/system";
        ...
        setenv("ANDROID_ROOT", rootDir, 1);
    }
    ...
    /* åˆ›å»ºè™šæ‹Ÿæœº */
    JniInvocation jni_invocation;
    jni_invocation.Init(NULL);
    JNIEnv* env;
    if (startVm(&mJavaVM, &env, zygote) != 0) {
        return;
    }
    onVmCreated(env);

    /*
     * åœ¨è™šæ‹Ÿæœºä¸­æ³¨å†Œä¸€ç³»åˆ—JNIæ–¹æ³•
     */
    if (startReg(env) < 0) {
        ...
        return;
    }

    /*
     * We want to call main() with a String array with arguments in it.
     * At present we have two arguments, the class name and an option string.
     * Create an array to hold them.
     */
    jclass stringClass;
    jobjectArray strArray;
    jstring classNameStr;

    stringClass = env->FindClass("java/lang/String");
    ...
    // åˆ›å»ºstring arrayç”¨äºè®°å½•å¯åŠ¨å‚æ•°åˆ—è¡¨
    strArray = env->NewObjectArray(options.size() + 1, stringClass, NULL);
    ...
    // åˆ›å»ºstringç”¨äºä¿å­˜ç±»å
    classNameStr = env->NewStringUTF(className);
    ...
    env->SetObjectArrayElement(strArray, 0, classNameStr);
    
    for (size_t i = 0; i < options.size(); ++i) { // åˆå§‹åŒ–å¯åŠ¨å‚æ•°åˆ—è¡¨
        jstring optionsStr = env->NewStringUTF(options.itemAt(i).string());
        ...
        env->SetObjectArrayElement(strArray, i + 1, optionsStr);
    }

    /*
     * Start VM.  This thread becomes the main thread of the VM, and will
     * not return until the VM exits.
     */
    char* slashClassName = toSlashClassName(className);
    jclass startClass = env->FindClass(slashClassName);
    if (startClass == NULL) {...
    } else {
        jmethodID startMeth = env->GetStaticMethodID(startClass, "main",
            "([Ljava/lang/String;)V"); // è·å¾—å…¥å£å‡½æ•°
        if (startMeth == NULL) {...
        } else {
            // ğŸè°ƒç”¨com/android/internal/os/ZygoteInit::main(...)å‡½æ•°
            env->CallStaticVoidMethod(startClass, startMeth, strArray);
...
        }
    }
    free(slashClassName);
    ...
}
```
ç”±æ­¤å¯è§ï¼Œzygoteçš„mainå‡½æ•°é‡Œå¯åŠ¨äº†è™šæ‹Ÿæœºï¼Œå¹¶åœ¨è™šæ‹Ÿæœºé‡Œæ‰§è¡Œå‡½æ•°`com.android.internal.os.ZygoteInit::main`ã€‚
# Step8 ZygoteInit::main(...)
``` java
// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java
package com.android.internal.os;
...
public class ZygoteInit {
...
//:565
    public static void main(String argv[]) {
        try {
            RuntimeInit.enableDdms();
            // Start profiling the zygote initialization.
            SamplingProfilerIntegration.start();

            boolean startSystemServer = false;
            String socketName = "zygote";
            String abiList = null;
            for (int i = 1; i < argv.length; i++) {
                if ("start-system-server".equals(argv[i])) {
                    startSystemServer = true; // å›é¡¾init.zygote*.rcï¼Œè¯¥å€¼ä¸ºtrue
                } else if (argv[i].startsWith(ABI_LIST_ARG)) {
                    abiList = argv[i].substring(ABI_LIST_ARG.length());
                } else if (argv[i].startsWith(SOCKET_NAME_ARG)) {
                    socketName = argv[i].substring(SOCKET_NAME_ARG.length());
                } else {...}
            }
            ...
            // ğŸStep9 åˆ›å»ºä¸€ä¸ªserverç«¯socketï¼Œç”¨æ¥ç­‰å¾…ActivityManagerService
            // è¯·æ±‚Zygoteåˆ›å»ºæ–°è¿›ç¨‹
            registerZygoteSocket(socketName);  // socketName="zygote"
            ...
            if (startSystemServer) { // true
                // ğŸStep10 å¯åŠ¨systemè¿›ç¨‹ï¼Œä»¥ä¾¿å®ƒå°†ç³»ç»Ÿçš„å…³é”®æœåŠ¡å¯åŠ¨èµ·æ¥
                startSystemServer(abiList, socketName);
            }

            // ğŸStep11ç­‰å¾…ActivityManagerServiceè¯·æ±‚Zygoteåˆ›å»ºæ–°è¿›ç¨‹
            runSelectLoop(abiList);
            ...
        } catch (MethodAndArgsCaller caller) {
            caller.run();
        } catch (RuntimeException ex) {...}
    }
```
# Step9 ZygoteInit::registerZygoteSocket(...)
``` java
// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:107
private static void registerZygoteSocket(String socketName) {
    // socketName = "zygote"
    if (sServerSocket == null) {
        int fileDesc;
        // fullSocketName = "ANDROID_SOCKET_zygote"
        // åœ¨Step5ä¸­å°†socketæè¿°ç¬¦å†™å…¥è¯¥ç¯å¢ƒå˜é‡
        final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;
        try {
            String env = System.getenv(fullSocketName);
            fileDesc = Integer.parseInt(env); // å–å‡ºsocketæè¿°ç¬¦
        } catch (RuntimeException ex) {...}

        try {
            FileDescriptor fd = new FileDescriptor();
            fd.setInt$(fileDesc);
            // æ ¹æ®æè¿°ç¬¦åˆ›å»ºä¸€ä¸ªserverç«¯socketï¼Œzygoteå°†systemè¿›ç¨‹å¯åŠ¨åå°±ä¼šåœ¨æ­¤
            // socketä¸Šç­‰å¾…ActivityManagerServiceæ¥è¯·æ±‚åˆ›å»ºæ–°è¿›ç¨‹
            sServerSocket = new LocalServerSocket(fd);
        } catch (IOException ex) {...}
    }
}
```
# Step10 ZygoteInit::startSystemServer(...)
``` java
// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:493
private static boolean startSystemServer(String abiList, String socketName)
        throws MethodAndArgsCaller, RuntimeException {
    long capabilities = posixCapabilitiesAsBits(
        OsConstants.CAP_BLOCK_SUSPEND,
        OsConstants.CAP_KILL,
        OsConstants.CAP_NET_ADMIN,
        OsConstants.CAP_NET_BIND_SERVICE,
        OsConstants.CAP_NET_BROADCAST,
        OsConstants.CAP_NET_RAW,
        OsConstants.CAP_SYS_MODULE,
        OsConstants.CAP_SYS_NICE,
        OsConstants.CAP_SYS_RESOURCE,
        OsConstants.CAP_SYS_TIME,
        OsConstants.CAP_SYS_TTY_CONFIG
    );
    /* æ„é€ systemè¿›ç¨‹çš„å¯åŠ¨å‚æ•°*/
    String args[] = {
        "--setuid=1000",
        "--setgid=1000",
        "--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007",
        "--capabilities=" + capabilities + "," + capabilities,
        "--nice-name=system_server",
        "--runtime-args",
        "com.android.server.SystemServer",
    };
    ZygoteConnection.Arguments parsedArgs = null;

    int pid;

    try {
        parsedArgs = new ZygoteConnection.Arguments(args);
        ...
        /* åˆ›å»ºsystemè¿›ç¨‹ */
        pid = Zygote.forkSystemServer(
                parsedArgs.uid, parsedArgs.gid,
                parsedArgs.gids,
                parsedArgs.debugFlags,
                null,
                parsedArgs.permittedCapabilities,
                parsedArgs.effectiveCapabilities);
    } catch (IllegalArgumentException ex) {...}

    /* For child process */
    if (pid == 0) {
        ...
        handleSystemServerProcess(parsedArgs); // ğŸåœ¨æ–°çš„å­è¿›ç¨‹ä¸­æ‰§è¡Œï¼Œä¸‹ä¸€èŠ‚ä»‹ç»
    }

    return true;
}
```
# Step11 ZygoteInit::runSelectLoop(...)
``` java
// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:662
    private static void runSelectLoop(String abiList) throws MethodAndArgsCaller {
        ArrayList<FileDescriptor> fds = new ArrayList<FileDescriptor>();
        ArrayList<ZygoteConnection> peers = new ArrayList<ZygoteConnection>();
        // sServerSocketæ˜¯Step9ä¸­åˆ›å»ºçš„serverç«¯socket
        fds.add(sServerSocket.getFileDescriptor());
        peers.add(null);

        // ç­‰å¾…ActivityManagerServiceè¯·æ±‚åˆ›å»ºæ–°è¿›ç¨‹ 
        while (true) {
            // å°†fdsè½¬ç§»åˆ°pollFdsä¸­
            StructPollfd[] pollFds = new StructPollfd[fds.size()];
            for (int i = 0; i < pollFds.length; ++i) {
                pollFds[i] = new StructPollfd();
                pollFds[i].fd = fds.get(i);
                pollFds[i].events = (short) POLLIN;
            }
            try { // ç›‘æ§socketæ˜¯å¦æœ‰æ•°æ®å¯è¯»
                Os.poll(pollFds, -1);
            } catch (ErrnoException ex) {...}
            for (int i = pollFds.length - 1; i >= 0; --i) {
                if ((pollFds[i].revents & POLLIN) == 0) {
                    continue;
                }
                if (i == 0) {
                    // ActivityManagerServiceé€šè¿‡sServerSocketä¸Zygoteå»ºç«‹è¿æ¥ï¼Œ
                    // ä½†è¿˜æ²¡æœ‰è¯·æ±‚ä½ç½®åˆ›å»ºæ–°è¿›ç¨‹ï¼Œå› æ­¤åªæ˜¯å°†æ­¤è¿æ¥æ·»åŠ åˆ°peersä¸­ï¼Œå¹¶å°†
                    // socketæè¿°ç¬¦æ·»åŠ åˆ°fdsï¼Œä¸€è¾¹æ¥ä¸‹æ¥å¯ä»¥æ¥æ”¶åˆ°åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚
                    ZygoteConnection newPeer = acceptCommandPeer(abiList);
                    peers.add(newPeer);
                    fds.add(newPeer.getFileDesciptor());
                } else {
                    // å¤„ç†ActivityManagerServiceçš„åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚
                    boolean done = peers.get(i).runOnce();
                    if (done) {
                        peers.remove(i);
                        fds.remove(i);
                    }
                }
            }
        }
    }
```
ä¸Android2.xç›¸æ¯”ï¼Œæ­¤å¤„ä½¿ç”¨epollæ›¿ä»£äº†selectï¼Œepollçš„å…·ä½“ç”¨æ³•å¯ä»¥å‚è§[ã€Šé”®ç›˜æ¶ˆæ¯å¤„ç†å­¦ä¹ ç¬”è®°ï¼ˆå››ï¼‰â€”â€”Looperæœºåˆ¶ã€‹](http://palanceli.com/2016/10/02/2016/1002KeyboardLearning4/#å…³äºepoll)ã€‚
# æ€»ç»“
Zygoteè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹å¦‚ä¸‹ï¼š
![Zygoteè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹](0127init1/img1.png)