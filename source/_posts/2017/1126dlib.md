---
layout: post
title: dlibçš„ä½¿ç”¨
date: 2017-11-26 20:00:00 +0800
categories: äººè„¸è¯†åˆ«
tags: dlib
toc: true
comments: true
---
æœ¬ç« è¦ç‚¹ï¼š
- dlibçš„å®‰è£…
- dlibç®€å•ä½¿ç”¨
- äººè„¸æ£€æµ‹ã€è¯†åˆ«
- äººè„¸åˆæˆ
- è®­ç»ƒè‡ªå·±çš„äººè„¸å…³é”®ç‚¹æ¨¡å‹

<!-- more -->
å› ä¸ºè¦ç”¨dlibåšä¸€ä¸ªäººè„¸è¯†åˆ«ï¼Œæ˜¨æ™šæäº†ä¸€ä¸‹dlib pythonçš„å®‰è£…å’Œä½¿ç”¨ï¼Œåœ¨macOSä¸‹é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚
# dlibçš„å®‰è£…
ä¸»è¦å®‰è£…æ­¥éª¤éå¸¸ç®€å•ï¼Œå¦‚æœpipèƒ½è‡ªå·±æå®šä¾èµ–é—®é¢˜å°±å¥½äº†ã€‚
## å®‰è£…æ­¥éª¤
dlibä¾èµ–boostï¼Œæ‰€ä»¥ç†æƒ³æƒ…å†µä¸‹åªéœ€è¦
``` bash
$ brew install boost-python
$ sudo pip install dlib
$ sudo pip install scikit-image
```
å› ä¸ºä¸‹é¢è¦è·‘ä¸€ä¸ªç¤ºä¾‹çš„éœ€è¦ï¼Œæœ€åä¸€æ­¥å®‰è£…äº†scikit-imageã€‚

## å…³é—­SIP
å¦‚æœç³»ç»Ÿå¼€å¯äº†ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤SIPï¼ˆSystemIntegrity Protectionï¼‰ï¼Œéœ€è¦ï¼š
- é‡å¯OSï¼ŒæŒ‰ä½âŒ˜+R
- ä»èœå•ä¸­è¿›å…¥ç»ˆç«¯ï¼Œè¾“å…¥`csrutil disable`ï¼Œå…³é—­SIP
- é‡å¯OS

å®Œæˆè¿™äº›æ­¥éª¤ä¹‹åå†æ“ä½œå‰é¢çš„dlibå®‰è£…æ­¥éª¤ï¼Œå®‰è£…æˆåŠŸåè®°å¾—åŒæ ·çš„æ­¥éª¤ï¼Œé€šè¿‡å‘½ä»¤`csrutil enable`æ¢å¤SIP

## é‡åˆ°çš„é—®é¢˜
æŠ˜è…¾æœ€ä¹…çš„æ˜¯è¿™ä¸ªé”™è¯¯ï¼š
```
#error "DLIB_NO_GUI_SUPPORT is defined so you can't use the GUI code.  Turn DLIB_NO_GUI_SUPPORT off if you want to use it."
     ^
    /usr/local/include/dlib/gui_core/gui_core_kernel_2.h:12:2: error: "Also make sure you have libx11-dev installed on your system"
    #error "Also make sure you have libx11-dev installed on your system"
     ^
```
ä¸çŸ¥é“æœ€æ ¹æœ¬çš„åŸå› æ˜¯å•¥ï¼Œå°è¯•äº†Nç§åŠæ³•ï¼Œæœ€åæˆ‘æ›´æ–°äº†ä¸€æŠŠXcodeï¼š
`$ sudo xcode-select --install`
å°±OKäº†ã€‚

# dlibçš„ä½¿ç”¨
## æ£€æµ‹äººè„¸åŒºåŸŸ
``` python
img = cv2.imread('images/girls.jpg')
rgbImg = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
detector = dlib.get_frontal_face_detector() # æ­£è„¸æ£€æµ‹å™¨
faces = detector(rgbImg, 1) # è¿”å›è„¸çš„ä¿¡æ¯
for face in faces:          # æ¡†å‡ºæ¯å¼ è„¸
    cv2.rectangle(img, (face.left(), face.top()), (face.right(), face.bottom()), (0, 255, 0), 1)
```
å¦‚å›¾ï¼Œè¾“å…¥ä¸€ä¸ªå¤šäººå›¾ç‰‡ï¼Œé€šè¿‡æ­£è„¸æ£€æµ‹å™¨å¯ä»¥æ£€æµ‹å‡ºæ¯å¼ è„¸çš„çŸ©å½¢åŒºåŸŸ
![](1126dlib/img01.png)

## æ£€æµ‹äººè„¸ç‰¹å¾ç‚¹
``` python
    img = cv2.imread('images/girls.jpg')
    rgbImg = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    detector = dlib.get_frontal_face_detector()
    faces = detector(rgbImg, 1)
    for face in faces:
        # è¯†åˆ«å‡ºå…³é”®ç‚¹ï¼ŒkeyPtsçš„ç±»å‹æ˜¯dlib.points
        keyPts = self.shapePredictor(img, face).parts()
        landmarks = numpy.matrix([[p.x,p.y] for p in keyPts]) 
        # ç”»å‡ºå…³é”®ç‚¹
        pts = numpy.array([landmarks], numpy.int32)
        cv2.polylines(img, pts.reshape(-1, 1, 2), True, (0, 255, 0), 2)
```
![](1126dlib/img03.png)

## è®¡ç®—äººè„¸ç‰¹å¾
``` python
img = io.imread(imgFile) # è¾“å…¥å•äººå¤´åƒ
detector = dlib.get_frontal_face_detector()
# æ£€æµ‹å‡ºäººè„¸åŒºåŸŸ
faces = detector(img, 1)
...
faceRect = faces[0]

# è®­ç»ƒå¥½çš„äººè„¸å…³é”®ç‚¹æ£€æµ‹å™¨æ•°æ®
predictorPath = 'extdata/shape_predictor_68_face_landmarks.dat'
# è®­ç»ƒå¥½çš„ResNetäººè„¸è¯†åˆ«æ¨¡å‹
faceRecModelPath = 'extdata/dlib_face_recognition_resnet_model_v1.dat'
shapePredictor = dlib.shape_predictor(predictorPath) # äººè„¸å…³é”®ç‚¹ç›‘æµ‹å™¨
faceRec = dlib.face_recognition_model_v1(faceRecModelPath) # äººè„¸è¯†åˆ«æ¨¡å‹

# å…³é”®ç‚¹æ£€æµ‹
shape = shapePredictor(img, faceRect)
# æè¿°é¡¹æå–ï¼Œ 128Då‘é‡
faceDescriptor = faceRec.compute_face_descriptor(img, shape)
# è½¬æ¢ä¸ºnumpu array
return numpy.array(faceDescriptor)
```
å…¶ä¸­ï¼š
`shape_predictor_68_face_landmarks.dat`æ˜¯å·²ç»è®­ç»ƒå¥½çš„[äººè„¸å…³é”®ç‚¹æ£€æµ‹å™¨æ•°æ®](http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2)ã€‚
`dlib_face_recognition_resnet_model_v1.dat`æ˜¯å·²ç»è®­ç»ƒå¥½çš„[ResNetäººè„¸è¯†åˆ«æ¨¡å‹](http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2)ã€‚
æˆ‘åœ¨faceRek/setup.shä¸­å†™äº†å·¥ç¨‹ä¾èµ–çš„å¤–éƒ¨æ•°æ®ï¼Œè¿è¡Œpythonä»£ç å‰å…ˆæ‰§è¡Œ
`sh setup.sh`

è¯¥æ®µä»£ç æå–åˆ°çš„128Då‘é‡å½¢å¼å¦‚ä¸‹ï¼š
``` bash
$ python -m unittest sample.DLibUT.test02
14:40 0117 DEBUG    
[ -1.32817209e-01   7.43134990e-02   7.68444687e-02  -1.05091885e-01
  -1.46399811e-01   4.86346148e-03  -1.23881295e-01  -1.71705186e-01
  ...               ...             ...             ...
  -1.90864969e-03   1.68816522e-02  -2.53906399e-01   1.30065437e-02
   1.57092661e-01  -9.88340452e-02   9.43705738e-02   5.99186197e-02]
```

## äººè„¸è¯†åˆ«
ç°æœ‰ä¸€å †å€™é€‰äººç…§ç‰‡ï¼Œç»™å®šä¸€ä¸ªå¾…è¯†åˆ«äººç…§ç‰‡ï¼Œè¯†åˆ«å‡ºä»–æ˜¯å€™é€‰äººä¸­çš„å“ªä¸€ä¸ªï¼Œè¿™æ˜¯äººè„¸è¯†åˆ«è§£å†³çš„ä¸»è¦é—®é¢˜ã€‚åº”ç”¨ä¸Šä¸€èŠ‚è®¡ç®—å‡ºçš„äººè„¸ç‰¹å¾ï¼Œè®¡ç®—å¾…è¯†åˆ«äººå’Œæ¯ä½å€™é€‰äººä¹‹é—´çš„ç‰¹å¾å·®ï¼Œæ±‚æœ€å°çš„é‚£ä¸ªå€™é€‰äººï¼Œå°±æ˜¯äººè„¸è¯†åˆ«çš„ä¸»è¦æ–¹æ³•ã€‚
ä½¿ç”¨`numpy.linalg.norm(candDesc - testDesc)`å¯ä»¥å°†128Då‘é‡è½¬åŒ–æˆä¸€ä¸ªæ•°å€¼ï¼Œæ±‚è¿™ä¸ªæœ€å°å€¼å³å¯ã€‚åœ¨faceRek/sample.DLibUT.test03æœ‰å®Œæ•´çš„ä»£ç ï¼Œè¯†åˆ«ç»“æœå¦‚ä¸‹ï¼Œè“è‰²æ˜¯è¯†åˆ«æ­£ç¡®çš„ï¼Œçº¢è‰²æ˜¯è¯†åˆ«é”™è¯¯çš„ï¼š
![](1126dlib/img02.png)
å®ƒæŠŠè«æ–‡è”šè¯†æˆäº†ruru ğŸ˜‚

## äººè„¸åˆæˆ
æˆ‘æœ¬æ¥æƒ³æ‰¾çš„åˆæˆæ˜¯æ ¹æ®ä¸€å¼ é¢å­”çš„ç‰¹å¾å»å˜æ¢å¦ä¸€å¼ é¢å­”ï¼Œä½†æˆ‘åªæ‰¾åˆ°äº†ä¸¤å¼ é¢å­”ç‰¹å¾éƒ¨åˆ†çš„å åŠ ï¼Œæš‚æ—¶ä¹Ÿå…ˆæ”¶ç€å§ã€‚ä¸å¿å¿ƒæ‹¿ç¾å¥³å¼€åˆ€ï¼Œå°±ç”¨æˆ‘è‡ªå·±çš„çœ‹æ•ˆæœå§ğŸ¤£
![](1126dlib/img04.png)

# è®­ç»ƒè‡ªå·±çš„äººè„¸å…³é”®ç‚¹æ¨¡å‹
åœ¨[dlib-models](https://github.com/davisking/dlib-models)ä¸­Davis Kingæåˆ°ï¼š[shape_predictor_68_face_landmarks.dat](http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2)æ‰€ä½¿ç”¨çš„æ•°æ®é›†è®¸å¯è¯ä¸åŒ…æ‹¬å•†ä¸šç”¨é€”ï¼Œå› æ­¤è¯¥è®­ç»ƒæ¨¡å‹ä¹Ÿä¸èƒ½ç”¨äºå•†ä¸šäº§å“ã€‚

è€Œä¸”è¯¥æ¨¡å‹å‹ç¼©å°ºå¯¸æœ‰61Mï¼Œè§£å¼€å99Mï¼Œä½œè€…åœ¨[Real-Time Face Pose Estimation](http://blog.dlib.net/2014/08/real-time-face-pose-estimation.html)çš„ä¸­æœ‰å¤§é‡çš„ç­”ç–‘ï¼Œå…³äºæ€§èƒ½ã€å’Œç¼–è¯‘ç­‰é—®é¢˜ï¼ŒDavis KingçœŸæ˜¯å‹¤å¥‹ï¼
- [è¿™é‡Œ](http://blog.dlib.net/2014/08/real-time-face-pose-estimation.html?showComment=1445290037220#c6512573392805280310)æåˆ°ï¼šå¦‚æœæƒ³å¾—åˆ°æ›´å°çš„æ•°æ®æ¨¡å‹ï¼Œå¯ä»¥åœ¨åŸå…ˆçš„æ•°æ®é›†ä¸Šåˆ å‡ä¸€äº›landmarksï¼Œå¹¶è‡ªå·±å®Œæˆè®­ç»ƒï¼ŒåŸå…ˆçš„è®­ç»ƒé›†æ•°æ®å¯ä»¥ä»[http://dlib.net/files/data/ibug_300W_large_face_landmark_dataset.tar.gz](http://dlib.net/files/data/ibug_300W_large_face_landmark_dataset.tar.gz)ä¸‹è½½ï¼›è®­ç»ƒä»£ç å‚è§[http://dlib.net/train_shape_predictor_ex.cpp.html](http://dlib.net/train_shape_predictor_ex.cpp.html)ï¼Œè¯¥ä»£ç ä½äº`dlib/examples/train_shape_predictor_ex.cpp`ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª5 landmarksçš„è®­ç»ƒé›†[http://dlib.net/files/data/dlib_faces_5points.tar](http://dlib.net/files/data/dlib_faces_5points.tar).
- [è¿™é‡Œ](http://blog.dlib.net/2014/08/real-time-face-pose-estimation.html?showComment=1410219350404#c1560932319064417228)æåˆ°ï¼šå¯ä»¥ä»HELENæ•°æ®é›†[http://www.ifp.illinois.edu/~vuongle2/helen/](http://www.ifp.illinois.edu/~vuongle2/helen/)ä¸­è·å–194 landmarksçš„è®­ç»ƒæ•°æ®ï¼Œå®Œæˆè‡ªå·±çš„è®­ç»ƒã€‚
- [è¿™é‡Œ](https://github.com/davisking/dlib-models)æåˆ°ï¼šæ¨¡å‹shape_predictor_68_face_landmarks.dat.bz2çš„æ•°æ®æºæ¥è‡ª[https://ibug.doc.ic.ac.uk/resources/facial-point-annotations/](https://ibug.doc.ic.ac.uk/resources/facial-point-annotations/)ï¼Œè¿™æ˜¯300ä¸‡æ•°æ®é›†ã€‚

ä½œè€…æä¾›çš„ç´ æå°±è¿™äº›ï¼Œè¶³å¤Ÿäº†ï¼æˆ‘çš„ç¼–è¯‘ç¯å¢ƒæ˜¯mac OSï¼Œgit clone dlibåˆ°æœ¬åœ°ï¼Œåˆ›å»ºç›®å½•dlib/examples/buildï¼Œç„¶åä½¿ç”¨cmakeï¼š
![](1126dlib/img05.png)
æœ‰ä¸€ä¸ªè­¦å‘Šä½†æ˜¯å¯ä»¥å¿½ç•¥ã€‚ä½¿ç”¨Xcodeæ‰“å¼€projectï¼Œæˆ‘æ‰“ç®—è®­ç»ƒæ•°æ®é›†dlib_faces_5pointsï¼Œå°†å…¶ç›®å½•ä¸‹çš„ä¸¤ä¸ªxmlæ–‡ä»¶åˆ†åˆ«æ”¹åä¸ºï¼š
`test_cleaned.xml` => `testing_with_face_landmarks.xml`
`train_cleaned.xml` => `training_with_face_landmarks.xml`
åœ¨Xcodeä¸­ç‚¹å‡»èœå•Product > Scheme > Edit Scheme...ï¼Œè®¾ç½®å‘½ä»¤è¡Œçš„è¾“å…¥å‚æ•°ï¼š
![](1126dlib/img06.png)
ç„¶åå°±å¯ä»¥è¿è¡Œäº†ï¼Œä¸è¿‡è¦åšå¥½æ€æƒ³å‡†å¤‡ï¼Œæˆ‘æŠŠ`training_with_face_landmarks.xml`ä¸­çš„5000å¤šå¼ å›¾ç åˆ°200å¤šå¼ ï¼Œæ•´ä¸ªè®­ç»ƒå’Œæµ‹è¯•è¿‡ç¨‹éœ€è¦åŠä¸ªå°æ—¶ï¼›å¦‚æœæŠŠ5000å¤šå¼ å›¾è·‘ä¸€éï¼Œä»logè¾“å‡ºçš„æç¤ºä¸Šæ¥çœ‹ï¼Œéœ€è¦24å°æ—¶ï¼æˆ‘ä¸çŸ¥é“é‚£300å¤šä¸‡å¼ ibugçš„æ•°æ®è·‘å®Œå¾—è¦å¤šé•¿æ—¶é—´ã€‚

è®­ç»ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è·‘å‡ºè¯„æµ‹ç»“æœï¼Œçœ‹èµ·æ¥è¿˜ä¸é”™ï¼š
```
mean training error: 0.011435
mean testing error:  0.00745601 
```

æ¥ä¸‹æ¥ç”¨pythonéªŒè¯ä¸€ä¸‹ï¼š
``` python
class DLibTrainingUT(unittest.TestCase):
    def setUp(self):
        ...
        self.mDetector = dlib.get_frontal_face_detector()   # æ­£è„¸æ£€æµ‹å™¨

    def getFaceLandmarksFromImg(self, img, predictorPath):
        # æ£€æµ‹å‡ºäººè„¸åŒºåŸŸ
        faces = self.mDetector(img, 1)
        ...
        faceRect = faces[0]

        self.mShapePredictor = dlib.shape_predictor(predictorPath) # äººè„¸å…³é”®ç‚¹ç›‘æµ‹å™¨
        # æå–å…³é”®ç‚¹
        keyPts = self.mShapePredictor(img, faceRect).parts()
        landmarks = numpy.matrix([[p.x, p.y] for p in keyPts])
        return landmarks

    def test01(self):
        ''' éªŒè¯è‡ªå·±è®­ç»ƒçš„æ¨¡å‹æ•ˆæœ '''
        imgFile = 'images/2-0.jpg'
        img = cv2.imread(imgFile)
        modelPath = '/Users/palance/Documents/SubVersions/dlib/examples/build/Debug/sp.dat'
        landmarks = self.getFaceLandmarksFromImg(img, modelPath)

        pts = numpy.array(landmarks, numpy.int32)
        cv2.polylines(img, pts.reshape(-1, 1, 2), True, (0, 255, 0), 2)

        font = cv2.FONT_HERSHEY_SIMPLEX 
        index = 0
        for pt in landmarks:
            x, y = pt[0, 0], pt[0, 1]
            text = '%d' % index
            cv2.putText(img, text, (x, y), font, 0.5, (255, 0, 0))
            index += 1

        self.waitToClose(img)
```
ç»“æœå¦‚ä¸‹ï¼š
![](1126dlib/img07.png)
è™½ç„¶åªç”¨äº†200å¤šå¼ å›¾ç‰‡ï¼Œç»“æœå¥½åƒè¿˜ä¸é”™ï¼

# å‚è€ƒ
[dlib github](https://github.com/davisking/dlib)
[dlib å®˜ç½‘](http://dlib.net/)
[scikit-image å®˜ç½‘](http://scikit-image.org)
[scikit-learn å®˜ç½‘](http://scikit-learn.org/stable/)
[ã€Š40è¡Œä»£ç çš„äººè„¸è¯†åˆ«å®è·µã€‹](http://blog.csdn.net/xingchenbingbuyu/article/details/68482838?ref=myrecommend)
[ã€ŠOpenCVå®è·µä¹‹è·¯â€”â€”ç”¨dlibåº“è¿›è¡Œäººè„¸æ£€æµ‹ä¸äººè„¸æ ‡è®°ï¼ˆPythonï¼‰ã€‹](http://blog.csdn.net/xingchenbingbuyu/article/details/51116354)
[ã€ŠOne Millisecond Face Alignment with an Ensemble of Regression Treesã€‹](http://www.csc.kth.se/~vahidk/papers/KazemiCVPR14.pdf)
[ã€ŠOrthogonal Procrustes problemã€‹](https://en.wikipedia.org/wiki/Orthogonal_Procrustes_problem)
[ã€ŠTransformation matrixã€‹](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations)
[ã€ŠSwitching Eds: Face swapping with Python, dlib, and OpenCVã€‹](http://matthewearl.github.io/2015/07/28/switching-eds-with-python/)
[ã€Šæ•™ä½ ç”¨200è¡ŒPythonä»£ç â€œæ¢è„¸â€ã€‹](http://geek.csdn.net/news/detail/36873)
[ã€Šæ‰‹æŠŠæ‰‹ï¼šä½¿ç”¨OpenCVè¿›è¡Œé¢éƒ¨åˆæˆâ€” C++ / Pythonã€‹](https://mp.weixin.qq.com/s?__biz=MjM5MTQzNzU2NA==&mid=2651641340&idx=1&sn=29e39cb6113120fe73b3c397f1c9d555)
[https://github.com/iamwx/FaceMorph](https://github.com/iamwx/FaceMorph)
[äººè„¸å…³é”®ç‚¹æ£€æµ‹å™¨çš„è®­ç»ƒ](http://blog.csdn.net/elaine_bao/article/details/53054533)



> æœ¬æ–‡æ¶‰åŠçš„æ‰€æœ‰ä»£ç éƒ½å·²æäº¤åˆ°githubä¸Šï¼š
[https://github.com/palanceli/facemojiSample/tree/master/faceRek](https://github.com/palanceli/facemojiSample/tree/master/faceRek)ã€‚