---
layout: post
title: dlibçš„ä½¿ç”¨
date: 2017-11-26 20:00:00 +0800
categories: äººè„¸è¯†åˆ«
tags: dlib
toc: true
comments: true
---
æœ¬ç« è¦ç‚¹ï¼š
- dlibçš„å®‰è£…
- dlibç®€å•ä½¿ç”¨

<!-- more -->
å› ä¸ºè¦ç”¨dlibåšä¸€ä¸ªäººè„¸è¯†åˆ«ï¼Œæ˜¨æ™šæäº†ä¸€ä¸‹dlib pythonçš„å®‰è£…å’Œä½¿ç”¨ï¼Œåœ¨macOSä¸‹é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚
# dlibçš„å®‰è£…
ä¸»è¦å®‰è£…æ­¥éª¤éå¸¸ç®€å•ï¼Œå¦‚æœpipèƒ½è‡ªå·±æå®šä¾èµ–é—®é¢˜å°±å¥½äº†ã€‚
## å®‰è£…æ­¥éª¤
dlibä¾èµ–boostï¼Œæ‰€ä»¥ç†æƒ³æƒ…å†µä¸‹åªéœ€è¦
``` bash
$ brew install boost-python
$ sudo pip install dlib
$ sudo pip install scikit-image
```
å› ä¸ºä¸‹é¢è¦è·‘ä¸€ä¸ªç¤ºä¾‹çš„éœ€è¦ï¼Œæœ€åä¸€æ­¥å®‰è£…äº†scikit-imageã€‚

## å…³é—­SIP
å¦‚æœç³»ç»Ÿå¼€å¯äº†ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤SIPï¼ˆSystemIntegrity Protectionï¼‰ï¼Œéœ€è¦ï¼š
- é‡å¯OSï¼ŒæŒ‰ä½âŒ˜+R
- ä»èœå•ä¸­è¿›å…¥ç»ˆç«¯ï¼Œè¾“å…¥`csrutil disable`ï¼Œå…³é—­SIP
- é‡å¯OS

å®Œæˆè¿™äº›æ­¥éª¤ä¹‹åå†æ“ä½œå‰é¢çš„dlibå®‰è£…æ­¥éª¤ï¼Œå®‰è£…æˆåŠŸåè®°å¾—åŒæ ·çš„æ­¥éª¤ï¼Œé€šè¿‡å‘½ä»¤`csrutil enable`æ¢å¤SIP

## é‡åˆ°çš„é—®é¢˜
æŠ˜è…¾æœ€ä¹…çš„æ˜¯è¿™ä¸ªé”™è¯¯ï¼š
```
#error "DLIB_NO_GUI_SUPPORT is defined so you can't use the GUI code.  Turn DLIB_NO_GUI_SUPPORT off if you want to use it."
     ^
    /usr/local/include/dlib/gui_core/gui_core_kernel_2.h:12:2: error: "Also make sure you have libx11-dev installed on your system"
    #error "Also make sure you have libx11-dev installed on your system"
     ^
```
ä¸çŸ¥é“æœ€æ ¹æœ¬çš„åŸå› æ˜¯å•¥ï¼Œå°è¯•äº†Nç§åŠæ³•ï¼Œæœ€åæˆ‘æ›´æ–°äº†ä¸€æŠŠXcodeï¼š
`$ sudo xcode-select --install`
å°±OKäº†ã€‚

# dlibçš„ä½¿ç”¨
## æ£€æµ‹äººè„¸åŒºåŸŸ
``` python
img = cv2.imread('images/girls.jpg')
rgbImg = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
detector = dlib.get_frontal_face_detector() # æ­£è„¸æ£€æµ‹å™¨
faces = detector(rgbImg, 1) # è¿”å›è„¸çš„ä¿¡æ¯
for face in faces:          # æ¡†å‡ºæ¯å¼ è„¸
    cv2.rectangle(img, (face.left(), face.top()), (face.right(), face.bottom()), (0, 255, 0), 1)
```
å¦‚å›¾ï¼Œè¾“å…¥ä¸€ä¸ªå¤šäººå›¾ç‰‡ï¼Œé€šè¿‡æ­£è„¸æ£€æµ‹å™¨å¯ä»¥æ£€æµ‹å‡ºæ¯å¼ è„¸çš„çŸ©å½¢åŒºåŸŸ
![](1126dlib/img01.png)

## è®¡ç®—äººè„¸ç‰¹å¾
``` python
img = io.imread(imgFile) # è¾“å…¥å•äººå¤´åƒ
detector = dlib.get_frontal_face_detector()
# æ£€æµ‹å‡ºäººè„¸åŒºåŸŸ
faces = detector(img, 1)
...
faceRect = faces[0]

# è®­ç»ƒå¥½çš„äººè„¸å…³é”®ç‚¹æ£€æµ‹å™¨æ•°æ®
predictorPath = 'extdata/shape_predictor_68_face_landmarks.dat'
# è®­ç»ƒå¥½çš„ResNetäººè„¸è¯†åˆ«æ¨¡å‹
faceRecModelPath = 'extdata/dlib_face_recognition_resnet_model_v1.dat'
shapePredictor = dlib.shape_predictor(predictorPath) # äººè„¸å…³é”®ç‚¹ç›‘æµ‹å™¨
faceRec = dlib.face_recognition_model_v1(faceRecModelPath) # äººè„¸è¯†åˆ«æ¨¡å‹

# å…³é”®ç‚¹æ£€æµ‹
shape = shapePredictor(img, faceRect)
# æè¿°é¡¹æå–ï¼Œ 128Då‘é‡
faceDescriptor = faceRec.compute_face_descriptor(img, shape)
# è½¬æ¢ä¸ºnumpu array
return numpy.array(faceDescriptor)
```
å…¶ä¸­ï¼š
`shape_predictor_68_face_landmarks.dat`æ˜¯å·²ç»è®­ç»ƒå¥½çš„[äººè„¸å…³é”®ç‚¹æ£€æµ‹å™¨æ•°æ®](http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2)ã€‚
`dlib_face_recognition_resnet_model_v1.dat`æ˜¯å·²ç»è®­ç»ƒå¥½çš„[ResNetäººè„¸è¯†åˆ«æ¨¡å‹](http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2)ã€‚
æå–åˆ°çš„128Då‘é‡å½¢å¼å¦‚ä¸‹ï¼š
``` bash
$ python -m unittest sample.DLibUT.test02
14:40 0117 DEBUG    
[ -1.32817209e-01   7.43134990e-02   7.68444687e-02  -1.05091885e-01
  -1.46399811e-01   4.86346148e-03  -1.23881295e-01  -1.71705186e-01
  ...               ...             ...             ...
  -1.90864969e-03   1.68816522e-02  -2.53906399e-01   1.30065437e-02
   1.57092661e-01  -9.88340452e-02   9.43705738e-02   5.99186197e-02]
```

## äººè„¸è¯†åˆ«
ç°æœ‰ä¸€å †å€™é€‰äººç…§ç‰‡ï¼Œç»™å®šä¸€ä¸ªå¾…è¯†åˆ«äººç…§ç‰‡ï¼Œè¯†åˆ«å‡ºä»–æ˜¯å€™é€‰äººä¸­çš„å“ªä¸€ä¸ªï¼Œè¿™æ˜¯äººè„¸è¯†åˆ«è§£å†³çš„ä¸»è¦é—®é¢˜ã€‚åº”ç”¨ä¸Šä¸€èŠ‚è®¡ç®—å‡ºçš„äººè„¸ç‰¹å¾ï¼Œè®¡ç®—å¾…è¯†åˆ«äººå’Œæ¯ä½å€™é€‰äººä¹‹é—´çš„ç‰¹å¾å·®ï¼Œæ±‚æœ€å°çš„é‚£ä¸ªå€™é€‰äººï¼Œå°±æ˜¯äººè„¸è¯†åˆ«çš„ä¸»è¦æ–¹æ³•ã€‚
ä½¿ç”¨`numpy.linalg.norm(candDesc - testDesc)`å¯ä»¥å°†128Då‘é‡è½¬åŒ–æˆä¸€ä¸ªæ•°å€¼ï¼Œæ±‚è¿™ä¸ªæœ€å°å€¼å³å¯ã€‚åœ¨faceRek/sample.DLibUT.test03æœ‰å®Œæ•´çš„ä»£ç ï¼Œè¯†åˆ«ç»“æœå¦‚ä¸‹ï¼Œè“è‰²æ˜¯è¯†åˆ«æ­£ç¡®çš„ï¼Œçº¢è‰²æ˜¯è¯†åˆ«é”™è¯¯çš„ï¼š
![](1126dlib/img02.png)
å®ƒæŠŠè«æ–‡è”šè¯†æˆäº†ruru ğŸ˜‚

æœ¬èŠ‚æ¶‰åŠçš„ä»£ç æ”¾åˆ°äº†[faceRek](https://github.com/palanceli/facemojiSample/tree/master/faceRek)ã€‚

# å‚è€ƒ
[dlib github](https://github.com/davisking/dlib)
[dlib å®˜ç½‘](http://dlib.net/)
[scikit-image å®˜ç½‘](http://scikit-image.org)
[scikit-learn å®˜ç½‘](http://scikit-learn.org/stable/)
[ã€Š40è¡Œä»£ç çš„äººè„¸è¯†åˆ«å®è·µã€‹](http://blog.csdn.net/xingchenbingbuyu/article/details/68482838?ref=myrecommend)