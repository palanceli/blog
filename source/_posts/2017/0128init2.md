---
layout: post
title: åˆ›ä¸–è®°ï¼ˆäºŒï¼‰â€”â€”systemè¿›ç¨‹çš„å¯åŠ¨
date: 2017-01-28 22:55:22 +0800
categories: Androidå­¦ä¹ ç¬”è®°
tags: systemè¿›ç¨‹
toc: true
comments: true
---
åœ¨[ã€Šåˆ›ä¸–è®°ï¼ˆä¸€ï¼‰â€”â€”Zygoteè¿›ç¨‹çš„å¯åŠ¨ã€‹ä¹‹Step10 ZygoteInit::startSystemServer(â€¦)](http://palanceli.com/2017/01/27/2017/0127init1/#Step10-ZygoteInit-startSystemServer-â€¦)ä¸­ï¼ŒZygoteå¯åŠ¨systemè¿›ç¨‹ï¼Œå¹¶æ‰§è¡ŒZygoteInit::handleSystemServerProcess(...)å‡½æ•°ä½œä¸ºè¯¥è¿›ç¨‹å…¥å£ã€‚æ¥ä¸‹æ¥å°±ä¸€æ¬¡å‡½æ•°ä¸ºèµ·ç‚¹ç»§ç»­åˆ†æã€‚<!-- more -->

# Step1 ZygoteInit::handleSystemServerProcess(...)
``` java
// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:415
private static void handleSystemServerProcess(
        ZygoteConnection.Arguments parsedArgs)
        throws ZygoteInit.MethodAndArgsCaller {

    closeServerSocket(); // ç”±äºæ˜¯ä»Zygoteè¿›ç¨‹forkè€Œæ¥ï¼Œå…ˆå…³é—­æ‰systemä¸éœ€è¦çš„socket
    ...
    if (parsedArgs.invokeWith != null) {...
    } else {
        ...
        /*
         * ğŸPass the remaining arguments to SystemServer.
         */
        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);
    }

    /* should never reach here */
}
```
# Step2 RuntimeInit::zygoteInit(...)
``` java
// frameworks/base/core/java/com/android/internal/os/RuntimeInit.java:269
    public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)
            throws ZygoteInit.MethodAndArgsCaller {
        ...
        commonInit();
        nativeZygoteInit(); // å¯åŠ¨ä¸€ä¸ªBinderçº¿ç¨‹æ± 
        applicationInit(targetSdkVersion, argv, classLoader);
    }
// :299
private static void applicationInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)
        throws ZygoteInit.MethodAndArgsCaller {
    // If the application calls System.exit(), terminate the process
    // immediately without running any shutdown hooks.  It is not possible to
    // shutdown an Android application gracefully.  Among other things, the
    // Android runtime shutdown hooks close the Binder driver, which can cause
    // leftover running threads to crash before the process actually exits.
    nativeSetExitWithoutCleanup(true);

    // We want to be fairly aggressive about heap utilization, to avoid
    // holding on to a lot of memory that isn't needed.
    VMRuntime.getRuntime().setTargetHeapUtilization(0.75f);
    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);

    final Arguments args;
    try {
        args = new Arguments(argv);
    } catch (IllegalArgumentException ex) {...}
    ...
    // Remaining arguments are passed to the start class's static main
    // ğŸè°ƒç”¨å‡½æ•°com.android.server.SystemServer::main(...)
    invokeStaticMain(args.startClass, args.startArgs, classLoader);
}
```
å‚è§[ã€Šåˆ›ä¸–è®°ï¼ˆä¸€ï¼‰â€”â€”Zygoteè¿›ç¨‹çš„å¯åŠ¨ã€‹ä¹‹Step10 ](http://palanceli.com/2017/01/27/2017/0127init1/#Step10-ZygoteInit-startSystemServer-â€¦)ï¼Œåœ¨å‡½æ•°ZygoteInit::startSystemServer(â€¦)ä¸­ä»¥ç¡¬ç¼–ç çš„å½¢å¼ç»„ç»‡systemçš„å¯åŠ¨å‚æ•°ï¼Œå…¶ä¸­args.startClass="com.android.server.SystemServer"ã€‚

# Step3 RuntimeInit::invokeStaticMain(...)
``` java
// frameworks/base/core/java/com/android/internal/os/RuntimeInit.java:198
private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader)
        throws ZygoteInit.MethodAndArgsCaller {
    Class<?> cl;

    try {
        cl = Class.forName(className, true, classLoader);
    } catch (ClassNotFoundException ex) {...}

    Method m;
    try {
        m = cl.getMethod("main", new Class[] { String[].class });
    } catch 
        ...
    /* 
     * This throw gets caught in ZygoteInit.main(), which responds
     * by invoking the exception's run() method. This arrangement
     * clears up all the stack frames that were required in setting
     * up the process.
     */
    throw new ZygoteInit.MethodAndArgsCaller(m, argv);
}
```
å‡½æ•°å°¾éƒ¨çš„æ³¨é‡Šè¯´çš„å¾ˆæ˜ç™½ï¼Œå¼‚å¸¸æ˜¯åœ¨[ã€Šåˆ›ä¸–è®°ï¼ˆä¸€ï¼‰â€”â€”Zygoteè¿›ç¨‹çš„å¯åŠ¨ã€‹ä¹‹Step8 ](http://palanceli.com/2017/01/27/2017/0127init1/#Step8-ZygoteInit-main-â€¦)ï¼Œ`ZygoteInit::main`å‡½æ•°ä¸­æ•è·å’Œæ‰§è¡Œï¼Œè¿™ä¸ªå¼‚å¸¸æ˜¯`com.android.server.SystemServer::main`å‡½æ•°ï¼Œæ•è·è¯¥å¼‚å¸¸åå°†æ‰§è¡Œæ­¤å‡½æ•°ã€‚è¿™ä¸ªæ‰‹æ³•æ˜¯ä¸ºäº†æ¸…é™¤æ‰€æœ‰å †æ ˆï¼Œä½¿systemè¿›ç¨‹è®¤ä¸ºå‡½æ•°`com.android.server.SystemServer::main`æ˜¯è¿›ç¨‹æ‰§è¡Œçš„èµ·ç‚¹ã€‚

# Step4 SystemServer::main(...)
``` java
// frameworks/base/services/java/com/android/server/SystemServer.java
public final class SystemServer {
// :167
    public static void main(String[] args) {
        new SystemServer().run();
    }
// :176
    private void run() {
        ...
        // Start services.
        try {
            startBootstrapServices(); // ğŸ
            startCoreServices();
            startOtherServices();
        } catch (Throwable ex) {...}
        ...
        // Loop forever.
        Looper.loop();
        ...
    }
```
# Step5 SystemServer::startBootstrapServices()
åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°å¾ˆå¤šç†Ÿæ‚‰çš„Serviceå¯åŠ¨
``` java
// frameworks/base/services/java/com/android/server/SystemServer.java:322
private void startBootstrapServices() {
    ...
    // Activity manager runs the show.
    mActivityManagerService = mSystemServiceManager.startService(
            ActivityManagerService.Lifecycle.class).getService();
    ...
    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);

    ...
    mSystemServiceManager.startService(LightsService.class);

    ...
    mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);

    ...
    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);

    ...
    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,
            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
    ...
    startSensorService();
}
```
# æ€»ç»“
æœ¬èŠ‚systemè¿›ç¨‹çš„å¯åŠ¨åªæ˜¯[å‰ä¸€èŠ‚Zygoteè¿›ç¨‹å¯åŠ¨](http://palanceli.com/2017/01/27/2017/0127init1)çš„ä¸€ä¸ªç¯èŠ‚ï¼Œsystemè¿›ç¨‹çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¯åŠ¨äº†è‹¥å¹²ç³»ç»ŸæœåŠ¡ï¼Œå¦‚ActivityManagerServiceã€PackageManagerServiceç­‰ã€‚å¯åŠ¨å®Œæ¯•ä¹‹åè¿”å›åˆ°[Zygoteè¿›ç¨‹çš„ZygoteInit::main(â€¦)å‡½æ•° ](http://palanceli.com/2017/01/27/2017/0127init1/#Step8-ZygoteInit-main-â€¦)ï¼Œå°†ç­‰å¾…å¤„ç†æ¥è‡ªActivityManagerServiceå¯åŠ¨æ–°è¿›ç¨‹çš„è¯·æ±‚ã€‚
systemè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹å¦‚ä¸‹ï¼š
![systemè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹](0128init2/img1.png)
