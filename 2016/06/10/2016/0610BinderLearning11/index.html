<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Binder学习笔记（十一）—— 智能指针 | Palance's Blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Binder学习笔记（十一）—— 智能指针</h1><a id="logo" href="/blog/.">Palance's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/blog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Binder学习笔记（十一）—— 智能指针</h1><div class="post-meta">Jun 10, 2016<span> | </span><span class="category"><a href="/blog/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/06/10/2016/0610BinderLearning11/" href="/blog/2016/06/10/2016/0610BinderLearning11/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#轻量级指针"><span class="toc-number">1.</span> <span class="toc-text">轻量级指针</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#情景分析"><span class="toc-number">1.1.</span> <span class="toc-text">情景分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#强-弱智能指针"><span class="toc-number">2.</span> <span class="toc-text">强/弱智能指针</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#强-弱智能指针的目的"><span class="toc-number">2.1.</span> <span class="toc-text">强/弱智能指针的目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#强-弱智能指针的使用"><span class="toc-number">2.2.</span> <span class="toc-text">强/弱智能指针的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#情景分析-1"><span class="toc-number">2.3.</span> <span class="toc-text">情景分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造sp对象和wp对象"><span class="toc-number">2.3.1.</span> <span class="toc-text">构造sp对象和wp对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RefBase构造函数"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">RefBase构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sp拷贝构造函数"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">sp拷贝构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wp拷贝构造函数"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">wp拷贝构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wp析构函数"><span class="toc-number">2.3.1.4.</span> <span class="toc-text">wp析构函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sp析构函数"><span class="toc-number">2.3.1.5.</span> <span class="toc-text">sp析构函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wp-promote-弱指针升格为强指针"><span class="toc-number">2.3.2.</span> <span class="toc-text">wp::promote()弱指针升格为强指针</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h1 id="&#x8F7B;&#x91CF;&#x7EA7;&#x6307;&#x9488;"><a href="#&#x8F7B;&#x91CF;&#x7EA7;&#x6307;&#x9488;" class="headerlink" title="&#x8F7B;&#x91CF;&#x7EA7;&#x6307;&#x9488;"></a>&#x8F7B;&#x91CF;&#x7EA7;&#x6307;&#x9488;</h1><p>Binder&#x7684;&#x5B66;&#x4E60;&#x5386;&#x7A0B;&#x722C;&#x5230;&#x9A71;&#x52A8;&#x7684;&#x534A;&#x5C71;&#x8170;&#x660E;&#x663E;&#x611F;&#x89C9;&#x8D8A;&#x6765;&#x8D8A;&#x9661;&#x5CED;&#xFF0C;&#x505C;&#x4E0B;&#x4E1A;&#x52A1;&#x5C42;&#x7684;&#x5B66;&#x4E60;&#xFF0C;&#x8865;&#x8865;&#x57FA;&#x7840;&#x5C42;&#x77E5;&#x8BC6;&#x5427;&#xFF0C;&#x8FD9;&#x9996;&#x5F53;&#x5176;&#x51B2;&#x7684;&#x5C31;&#x662F;&#x667A;&#x80FD;&#x6307;&#x9488;&#x4E86;&#xFF0C;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x5F71;&#x5B50;&#x5728;Android&#x6E90;&#x7801;&#x4E2D;&#x968F;&#x5904;&#x53EF;&#x89C1;&#x3002;&#x6253;&#x5F00;frameworkds/rs/cpp/util&#xFF0C;RefBase.h&#x548C;StrongPointer.h&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x4EE3;&#x7801;&#x591A;&#x8BFB;&#x51E0;&#x904D;&#x90FD;&#x80FD;&#x8BFB;&#x61C2;&#xFF0C;&#x53EF;&#x662F;&#x4E32;&#x8D77;&#x6765;&#x603B;&#x611F;&#x89C9;&#x6478;&#x4E0D;&#x5230;&#x9AA8;&#x67B6;&#xFF0C;&#x628A;&#x4E0D;&#x4F4F;&#x4E3B;&#x7EBF;&#x3002;&#x95ED;&#x4E0A;&#x773C;&#x96F6;&#x96F6;&#x661F;&#x661F;&#x7684;&#x70B9;&#x4E32;&#x4E0D;&#x6210;&#x4E00;&#x6761;&#x7EBF;&#x3002;&#x7A76;&#x5176;&#x539F;&#x56E0;&#x5E94;&#x8BE5;&#x662F;&#x6B64;&#x5904;&#x4F7F;&#x7528;&#x4E86;&#x6A21;&#x5F0F;&#xFF0C;&#x6700;&#x597D;&#x5148;&#x5254;&#x9664;&#x6389;&#x4E1A;&#x52A1;&#x5C42;&#x7684;&#x76AE;&#x8089;&#xFF0C;&#x628A;&#x6A21;&#x5F0F;&#x7684;&#x9AA8;&#x67B6;&#x6478;&#x4E2A;&#x95E8;&#x6E05;&#xFF0C;&#x518D;&#x56DE;&#x6765;&#x770B;&#x4EE3;&#x7801;&#x5C31;&#x4F1A;&#x52BF;&#x5982;&#x7834;&#x7AF9;&#x4E86;&#x3002;</p>
<p>&#x4E0D;&#x662F;&#x591A;&#x4E48;&#x9AD8;&#x6DF1;&#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x667A;&#x80FD;&#x6307;&#x9488;&#x548C;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x6DF7;&#x5408;&#x800C;&#x5DF2;&#x3002;&#x4F46;&#xFF0C;&#x4E0D;&#x8981;&#x8F7B;&#x654C;&#x3002;&#x7FFB;&#x5F00;&#x4E66;&#xFF0C;&#x5BF9;&#x8FD9;&#x4E24;&#x4E2A;&#x6A21;&#x5F0F;&#x7684;&#x63CF;&#x8FF0;&#x7ADF;&#x6709;50&#x9875;&#x4E4B;&#x591A;&#x3002;&#x6211;&#x8BFB;&#x7684;&#x662F;Scott Meyers&#x7684;&#x300A;More Effective C++&#x300B;&#xFF0C;&#x4FAF;sir&#x7FFB;&#x8BD1;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x5341;&#x5E74;&#x524D;&#x8BFB;&#x8FD9;&#x672C;&#x4E66;&#x7684;&#x65F6;&#x5019;&#x56EB;&#x56F5;&#x541E;&#x67A3;&#x5F88;&#x591A;&#x8BFB;&#x4E0D;&#x61C2;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;&#x6982;&#x5FF5;&#x4F9D;&#x7A00;&#x7559;&#x4E0B;&#x70B9;&#x5370;&#x8C61;&#x3002;&#x8FD9;&#x4E9B;&#x5370;&#x8C61;&#x5C31;&#x6784;&#x6210;&#x4E86;&#x65E5;&#x540E;&#x9047;&#x5230;&#x95EE;&#x9898;&#x65F6;&#x7684;&#x8DEF;&#x6807;&#xFF0C;&#x544A;&#x8BC9;&#x6211;&#x7B54;&#x6848;&#x5728;&#x54EA;&#x91CC;&#x3002;&#x8FD9;&#x672C;&#x4E66;&#x6761;&#x6B3E;28&#x3001;29&#x8BB2;&#x7684;&#x6B63;&#x662F;&#x667A;&#x80FD;&#x6307;&#x9488;&#x548C;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x4E24;&#x7AE0;&#x7ED3;&#x5C3E;&#x5904;&#x7684;&#x4EE3;&#x7801;&#x51E0;&#x4E4E;&#x5C31;&#x662F;Android&#x6E90;&#x7801;&#x4E2D;LightRefBase&#x548C;sp&#x7684;&#x539F;&#x578B;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;&#x6761;&#x6B3E;&#x90FD;&#x4ECE;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x76EE;&#x6807;&#x5165;&#x624B;&#xFF0C;&#x4E0D;&#x65AD;&#x5730;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#xFF0C;&#x518D;&#x5347;&#x7EA7;&#x63D0;&#x51FA;&#x5B83;&#x7684;&#x4E0D;&#x8DB3;&#xFF0C;&#x518D;&#x627E;&#x7B54;&#x6848;&#xFF0C;&#x76F4;&#x5230;&#x628A;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x6253;&#x7A7F;&#x6253;&#x900F;&#x4E3A;&#x6B62;&#x3002;&#x8FD9;&#x4E24;&#x4E2A;&#x6761;&#x6B3E;&#x7684;&#x5185;&#x5BB9;&#x5C31;&#x4E0D;&#x8D58;&#x8FF0;&#x4E86;&#xFF0C;&#x4E66;&#x91CC;&#x5199;&#x7684;&#x66F4;&#x7CBE;&#x5F69;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x628A;&#x6A21;&#x5F0F;&#x548C;Android&#x6E90;&#x7801;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x5BF9;&#x63A5;&#x8D77;&#x6765;&#x3002;</p>
<p>&#x300A;More Effective C++&#x300B;&#x7B2C;203&#x9875;&#xFF0C;&#x6761;&#x6B3E;29&#x63CF;&#x7ED8;&#x4E86;&#x5177;&#x6709;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x529F;&#x80FD;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x6A21;&#x5F0F;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img01.png" alt="&#x300A;More Effective C++&#x300B;&#x6761;&#x6B3E;29"><br>&#x8FD9;&#x5F20;&#x56FE;&#x8FD8;&#x662F;&#x628A;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x548C;&#x6A21;&#x5F0F;&#x6846;&#x67B6;&#x6DF7;&#x5728;&#x4E00;&#x8D77;&#x4E86;&#xFF1A;</p>
<ul>
<li>String&#x4EE3;&#x8868;&#x4E1A;&#x52A1;&#x903B;&#x8F91;</li>
<li>RCPtr&#x662F;&#x5177;&#x5907;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x529F;&#x80FD;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;</li>
<li>RCObject&#x7528;&#x6765;&#x5C65;&#x884C;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x804C;&#x8D23;</li>
<li>StringValue&#x548C;HeapMemory&#x53C8;&#x662F;&#x5C40;&#x90E8;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x4E86;</li>
</ul>
<p>&#x6240;&#x4EE5;&#x8BE5;&#x6A21;&#x5F0F;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x7531;RCPtr&#x548C;RCObject&#x8054;&#x8882;&#x5B8C;&#x6210;&#xFF0C;RCPtr&#x8D1F;&#x8D23;&#x667A;&#x80FD;&#x6307;&#x9488;&#xFF0C;RCObject&#x8D1F;&#x8D23;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img02.png" alt="&#x5177;&#x5907;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x529F;&#x80FD;&#x5F97;&#x667A;&#x80FD;&#x6307;&#x9488;"><br>&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x5982;&#x679C;&#x8981;&#x914D;&#x5907;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x548C;&#x667A;&#x80FD;&#x6307;&#x9488;&#xFF0C;&#x5219;&#x9700;&#x8981;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> MyClass : <span class="keyword">public</span> RCObject <span class="comment">// &#x8BA9;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x7C7B;&#x4ECE;RCObject&#x6D3E;&#x751F;</span></span><br><span class="line">{...};</span><br><span class="line">RCPtr&lt;MyClass&gt; pObj; <span class="comment">// &#x58F0;&#x660E;&#x5BF9;&#x8C61;</span></span><br></pre></td></tr></table></figure></p>
<p>&#x5BF9;&#x5E94;&#x5230;Android&#x6E90;&#x7801;&#x4E2D;&#xFF0C;LightRefBase&#x5C31;&#x662F;RCObject&#xFF0C;sp&#x5C31;&#x662F;RCPtr&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img03.png" alt="Android&#x6E90;&#x7801;&#x4E2D;&#x7684;&#x8F7B;&#x91CF;&#x7EA7;&#x667A;&#x80FD;&#x6307;&#x9488;"></p>
<p>&#x6211;&#x5728;&#x521D;&#x8BFB;Android&#x6E90;&#x7801;&#x7684;&#x65F6;&#x5019;&#x4E00;&#x76F4;&#x7422;&#x78E8;&#x4E3A;&#x4EC0;&#x4E48;&#x641E;&#x5F97;&#x8FD9;&#x4E48;&#x590D;&#x6742;&#xFF0C;&#x4E0D;&#x80FD;&#x628A;&#x667A;&#x80FD;&#x6307;&#x9488;&#x5C01;&#x88C5;&#x5728;&#x4E00;&#x4E2A;&#x57FA;&#x7C7B;&#x91CC;&#x3002;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x7684;&#x8BDD;&#xFF0C;MyClass&#x53EA;&#x9700;&#x8981;&#x4ECE;&#x8FD9;&#x4E2A;&#x7C7B;&#x6D3E;&#x751F;&#x5C31;&#x597D;&#x4E86;&#x3002;&#x7B54;&#x6848;&#x662F;&#x4E0D;&#x53EF;&#x4EE5;&#x3002;&#x56E0;&#x4E3A;RCPtr&#x672C;&#x8D28;&#x4E0A;&#x8981;&#x5145;&#x5F53;&#x6307;&#x9488;&#x7684;&#x89D2;&#x8272;&#xFF0C;ptr1&#x53EF;&#x4EE5;&#x6307;&#x5411;A&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x6307;&#x5411;B&#xFF0C;&#x5F53;&#x4ECE;A&#x8F6C;&#x5411;&#x4E86;B&#xFF0C;&#x5E94;&#x8BE5;&#x8BA9;A&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#xFF0C;&#x8BA9;B&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x589E;&#xFF0C;&#x8FD9;&#x4E2A;&#x8BA1;&#x6570;&#x53EA;&#x80FD;&#x662F;&#x88AB;&#x6307;&#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x800C;&#x4E0D;&#x80FD;&#x662F;&#x6307;&#x9488;&#x7684;&#x3002;</p>
<p>&#x6211;&#x4E4B;&#x6240;&#x4EE5;&#x4F1A;&#x6709;&#x5408;&#x4E8C;&#x4E3A;&#x4E00;&#x7684;&#x5E74;&#x5934;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x8FC7;&#x53BB;&#x63A5;&#x89E6;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x5927;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x9047;&#x5230;Exception&#x6216;&#x9519;&#x8BEF;&#x8FD4;&#x56DE;&#x65F6;&#x9632;&#x6B62;&#x5185;&#x5B58;&#x6216;&#x8D44;&#x6E90;&#x6CC4;&#x9732;&#xFF0C;&#x53C8;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;goto&#x8BED;&#x53E5;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun</span><span class="params">(<span class="keyword">char</span> * filename)</span></span><br><span class="line"></span>{</span><br><span class="line">    FILE* fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span></span><br><span class="line">    ... ...</span><br><span class="line">    <span class="keyword">if</span>(error){</span><br><span class="line">        result = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    fclose(fp);</span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5982;&#x679C;&#x5728;&#x51FD;&#x6570;&#x4E2D;&#x6253;&#x5F00;&#x4E86;&#x591A;&#x79CD;&#x8D44;&#x6E90;&#xFF0C;&#x5219;&#x8981;&#x4E48;&#x8BB0;&#x4F4F;&#x5B83;&#x4EEC;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5728;exit&#x4E2D;&#x6839;&#x636E;&#x72B6;&#x6001;&#x64E6;&#x5C41;&#x80A1;&#xFF1B;&#x8981;&#x4E48;&#x5C31;&#x5F97;&#x6709;&#x591A;&#x4E2A;goto&#x6807;&#x8BB0;&#x3002;&#x6B64;&#x65F6;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x601D;&#x60F3;&#xFF0C;&#x7ED9;&#x6587;&#x4EF6;&#x505A;&#x4E2A;&#x5C01;&#x88C5;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">char</span> * filename)</span></span><br><span class="line"></span>{</span><br><span class="line">    MyFile file;  <span class="comment">// MyFile&#x5728;&#x6790;&#x6784;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x81EA;&#x52A8;&#x5173;&#x95ED;&#x6587;&#x4EF6;</span></span><br><span class="line">    <span class="keyword">if</span>(!file.open(filename, <span class="string">&quot;r&quot;</span>))</span><br><span class="line">        return <span class="number">-1</span>;</span><br><span class="line">    ... ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x4E00;&#x7C7B;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x53EF;&#x4EE5;&#x770B;&#x505A;&#x201C;&#x5177;&#x5907;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x201D;&#x7684;&#x7279;&#x4F8B;&#xFF0C;&#x5B83;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6700;&#x591A;&#x4E3A;1&#xFF0C;&#x4E14;&#x4E0D;&#x5B58;&#x5728;&#x6240;&#x6709;&#x6743;&#x7684;&#x8F6C;&#x79FB;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;&#x5F15;&#x7528;&#x8BA1;&#x6570;RCObject&#x6A21;&#x5757;&#x9000;&#x5316;&#x6389;&#xFF0C;&#x6307;&#x9488;&#x6307;&#x5411;&#x8D44;&#x6E90;&#x5373;&#x4EE3;&#x8868;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1&#xFF0C;&#x4E0D;&#x6307;&#x5411;&#x4EFB;&#x4F55;&#x8D44;&#x6E90;&#x5219;&#x4EE3;&#x8868;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0&#x3002;&#x56E0;&#x6B64;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x53EF;&#x4EE5;&#x8BA9;MyClass&#x4EC5;&#x6D3E;&#x751F;&#x81EA;RCPtr&#x57FA;&#x7C7B;&#x5373;&#x53EF;&#xFF0C;&#x4E00;&#x65E6;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5141;&#x8BB8;&#x5927;&#x4E8E;1&#xFF0C;&#x5C31;&#x5FC5;&#x987B;&#x5E26;&#x4E0A;RCObject&#x7684;&#x89D2;&#x8272;&#x4E86;&#x3002;</p>
<p>&#x56DE;&#x5230;Android&#x6E90;&#x7801;&#x4E0A;&#x6765;&#xFF0C;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#xFF1A;</p>
<ul>
<li>LightRefBase&#x8D1F;&#x8D23;&#x7EF4;&#x62A4;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x9012;&#x589E;/&#x9012;&#x51CF;&#x7684;&#x63A5;&#x53E3;&#x3002;</li>
<li>sp&#x5C65;&#x884C;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x89D2;&#x8272;&#xFF0C;&#x8D1F;&#x8D23;&#x6784;&#x9020;&#x6790;&#x6784;&#x3001;&#x62F7;&#x8D1D;&#x548C;&#x8D4B;&#x503C;&#x3001;&#x63D0;&#x9886;&#x3002;</li>
</ul>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;LightRefBase&#x548C;&#x300A;More Effective C++&#x300B;&#x6761;&#x6B3E;29&#x4E2D;&#x7684;RCObject&#x76F8;&#x6BD4;&#x591A;&#x51FA;&#x4E00;&#x4E2A;&#x6A21;&#x677F;&#x53C2;&#x6570;&#xFF0C;&#x5728;&#x8BE5;&#x7C7B;&#x7684;&#x5B9A;&#x4E49;&#x4E2D;&#x51E0;&#x4E4E;&#x6CA1;&#x6709;&#x7528;&#x5230;&#x8FD9;&#x4E2A;&#x6A21;&#x677F;&#x53C2;&#x6570;&#xFF0C;&#x8FD9;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x5206;&#x6790;&#x5E94;&#x8BE5;&#x662F;&#x51FA;&#x4E8E;&#x6027;&#x80FD;&#x7684;&#x8003;&#x8651;&#x2014;&#x2014;&#x8FD9;&#x6837;&#x505A;&#x53EF;&#x4EE5;&#x7701;&#x53BB;&#x865A;&#x8868;&#x7684;&#x5F00;&#x9500;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RCObject::removeReference()</span><br><span class="line">{<span class="keyword">if</span>(--refCount == <span class="number">0</span>) <span class="keyword">delete</span> <span class="keyword">this</span>;}</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x91CC;&#x8981;&#x7ECF;&#x7531;&#x57FA;&#x7C7B;&#x7684;&#x6307;&#x9488;&#x5220;&#x9664;&#x6D3E;&#x751F;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x300A;Effecive C++&#xFF08;&#x7B2C;&#x4E09;&#x7248;&#xFF09;&#x300B;&#xFF08;&#x521A;&#x521A;&#x53D1;&#x73B0;&#x8FD9;&#x672C;&#x4E66;&#x7684;&#x7B2C;&#x4E8C;&#x7248;&#x548C;&#x7B2C;&#x4E09;&#x7248;&#x8C03;&#x6574;&#x5F88;&#x5927;&#xFF01;&#xFF09;&#x7B2C;7&#x6761;&#x4E2D;&#x8BF4;&#x5230;:</p>
<blockquote>
<p>&#x5F53;&#x6D3E;&#x751F;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#x7ECF;&#x7531;&#x57FA;&#x7C7B;&#x6307;&#x9488;&#x88AB;&#x5220;&#x9664;&#x65F6;&#xFF0C;&#x57FA;&#x7C7B;&#x5FC5;&#x987B;&#x6709;&#x865A;&#x6790;&#x6784;&#x51FD;&#x6570;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x5BFC;&#x81F4;&#x672A;&#x5B9A;&#x4E49;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x901A;&#x5E38;&#x662F;&#x5BF9;&#x8C61;&#x7684;devrived&#x6210;&#x5206;&#x6CA1;&#x88AB;&#x9500;&#x6BC1;&#x3002;</p>
</blockquote>
<p>RCObject&#x786E;&#x5B9E;&#x58F0;&#x660E;&#x4E86;&#x6790;&#x6784;&#x51FD;&#x6570;&#x4E3A;virtual&#xFF0C;&#x4E5F;&#x56E0;&#x6B64;&#x4E0D;&#x5F97;&#x4E0D;&#x5F15;&#x5165;&#x865A;&#x8868;&#x3002;&#x518D;&#x770B;LightRefBase&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> LightRefBase</span><br><span class="line">{</span><br><span class="line">... ...</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">decStrong</span><span class="params">(<span class="keyword">const</span> Void* id)</span> <span class="keyword">const</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(android_atomic_dec(&amp;mCount) == <span class="number">1</span>){</span><br><span class="line">            <span class="comment">// &#x8FD9;&#x91CC;&#x5E76;&#x6CA1;&#x6709;delete this&#xFF0C;&#x800C;&#x662F;&#x5148;&#x8F6C;&#x6210;&#x5B50;&#x7C7B;&#x518D;delete&#xFF0C;&#x8FD9;&#x5C31;&#x4E0D;&#x518D;&#x662F;</span></span><br><span class="line">            <span class="comment">// &#x201C;&#x7ECF;&#x7531;&#x57FA;&#x7C7B;&#x6307;&#x9488;&#x5220;&#x9664;&#x5B50;&#x7C7B;&#x5BF9;&#x8C61;&#x201D;&#xFF0C;&#x800C;&#x662F;&#x201C;&#x7531;&#x5B50;&#x7C7B;&#x6307;&#x9488;&#x5220;&#x9664;&#x5B50;&#x7C7B;&#x5BF9;&#x8C61;&#x201D;&#x4E86;&#xFF0C;</span></span><br><span class="line">            <span class="comment">// &#x600E;&#x4E48;&#x5F97;&#x5230;&#x5B50;&#x7C7B;&#x6307;&#x9488;&#xFF1F;&#x6A21;&#x677F;&#x53C2;&#x6570;T&#x5440;&#xFF01;&#x4E3A;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x62CD;&#x6848;&#x53EB;&#x7EDD;&#xFF01;</span></span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> T*&gt;(<span class="keyword">this</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<h2 id="&#x60C5;&#x666F;&#x5206;&#x6790;"><a href="#&#x60C5;&#x666F;&#x5206;&#x6790;" class="headerlink" title="&#x60C5;&#x666F;&#x5206;&#x6790;"></a>&#x60C5;&#x666F;&#x5206;&#x6790;</h2><p>Android&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x591A;&#xFF0C;&#x4E14;&#x6BD4;&#x8F83;&#x72EC;&#x7ACB;&#xFF0C;&#x6211;&#x628A;&#x5B83;&#x4EEC;&#x62BD;&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x518D;&#x5199;&#x4E00;&#x4E9B;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#xFF0C;&#x5BF9;&#x8FD9;&#x5757;&#x4EE3;&#x7801;&#x7684;&#x7406;&#x89E3;&#x5927;&#x6709;&#x88E8;&#x76CA;&#x3002;&#x6211;&#x5728;Anrdoid&#x6E90;&#x7801;&#x4E2D;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x5934;&#x90E8;&#x90FD;&#x6253;&#x4E86;Log&#xFF0C;&#x6807;&#x793A;&#x51FD;&#x6570;&#x540D;&#x3002;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x5230;&#x8FD9;&#x91CC;&#x4E0B;&#x8F7D;<a href="https://github.com/palanceli/androidex/tree/master/host-smartptr" target="_blank" rel="external">androidex/host-smartptr</a>&#x3002;&#x8FD9;&#x91CC;&#x7684;Android&#x6E90;&#x7801;&#x53D6;&#x81EA;android-6.0.1_r11&#x3002;</p>
<ul>
<li>StrongPointer.h<br>&#x6765;&#x81EA;<code>frameworks/rs/cpp/util/StrongPointer.h</code></li>
<li>RefBase.h<br>&#x6765;&#x81EA;<code>frameworks/rs/cpp/util/RefBase.h</code></li>
<li>RefBase.cpp<br>&#x6765;&#x81EA;<code>system/core/libutils/RefBase.cpp</code></li>
<li>meyers.h<br>&#x6765;&#x81EA;&#x300A;More Effective C++&#x300B;&#x6761;&#x6B3E;29&#xFF0C;&#x662F;&#x5E26;&#x6709;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x529F;&#x80FD;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x5B9E;&#x73B0;</li>
<li>testlightptr.cpp&#x548C;testweightptr.cpp<br>&#x662F;&#x5BF9;Android&#x8F7B;&#x91CF;&#x7EA7;&#x667A;&#x80FD;&#x6307;&#x9488;&#x548C;&#x5F3A;&#x3001;&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#xFF0C;</li>
<li>logger.h<br>&#x662F;&#x4E00;&#x4E2A;log&#x5DE5;&#x5177;&#xFF0C;</li>
<li>smartptr.cpp<br>&#x662F;&#x4E3B;&#x5165;&#x53E3;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x6587;&#x4EF6;&#x5305;&#x542B;&#x82E5;&#x5E72;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#xFF0C;&#x51FD;&#x6570;&#x540D;&#x4E3A;tc01&#x3001;tc02&#x2026;</li>
</ul>
<p>&#x8BE5;&#x7A0B;&#x5E8F;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E3A;&#xFF1A;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smartptr &lt;tcname&gt;</span><br></pre></td></tr></table></figure></p>
<p>&#x4F8B;&#x5982;&#xFF1A;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smartptr tc01  <span class="comment"># &#x5B83;&#x6267;&#x884C;&#x4F8B;&#x7A0B;&#x51FD;&#x6570;tc01</span></span><br></pre></td></tr></table></figure></p>
<p>&#x4E00;&#x4E0B;&#x662F;&#x5BF9;&#x8F7B;&#x91CF;&#x7EA7;&#x6307;&#x9488;&#x7684;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">&quot;RefBase.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">&quot;logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> LightClass : <span class="keyword">public</span> LightRefBase &lt;LightClass&gt;</span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    LightClass(){}</span><br><span class="line">    ~LightClass(){}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">testlightptr</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> * argv[])</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="comment">// &#x521D;&#x59CB;lpLightClass&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0</span></span><br><span class="line">    LightClass * pLightClass = new LightClass();</span><br><span class="line">    <span class="comment">// &#x8C03;&#x7528;sp&#x7684;&#x590D;&#x5236;&#x6784;&#x9020;&#x51FD;&#x6570;sp::sp(T* other)&#xFF0C;&#x4F7F;&#x5F97;pLightClass&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1&#x3002;</span></span><br><span class="line">    sp&lt;LightClass&gt; lpOut = pLightClass;</span><br><span class="line">    Logging(<span class="string">&quot;Light Ref Count: %d.&quot;</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// &#x8C03;&#x7528;sp&#x7684;&#x8D4B;&#x503C;&#x6784;&#x9020;&#x51FD;&#x6570;sp::sp(const sp&lt;T&gt;&amp; other)&#xFF0C;</span></span><br><span class="line">        <span class="comment">// &#x4F7F;&#x5F97;pLightClass&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7D2F;&#x52A0;&#x4E3A;2</span></span><br><span class="line">        sp&lt;LightClass&gt; lpInner = lpOut;</span><br><span class="line">        Logging(<span class="string">&quot;Light Ref Count: %d.&quot;</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line">        <span class="comment">// lpInner&#x6790;&#x6784;&#xFF0C;pLightClass&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x4E3A;1</span></span><br><span class="line">    }</span><br><span class="line">    Logging(<span class="string">&quot;Light Ref Count:%d.&quot;</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// lpOut&#x6790;&#x6784;&#xFF0C;pLightClass&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x4E3A;0&#xFF0C;&#x5728;decStrong(...)&#x4E2D;delete pLightClass</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6267;&#x884C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./smartptr tc01</span><br><span class="line">[StrongPointer.h:41] sp::sp(T*)</span><br><span class="line">[testlightptr.cpp:16] Light Ref Count: 1.</span><br><span class="line">[StrongPointer.h:47] sp::sp(const sp&lt;T&gt;&amp;)</span><br><span class="line">[testlightptr.cpp:19] Light Ref Count: 2.</span><br><span class="line">[StrongPointer.h:53] sp::~sp()</span><br><span class="line">[testlightptr.cpp:21] Light Ref Count:1.</span><br><span class="line">[StrongPointer.h:53] sp::~sp()</span><br></pre></td></tr></table></figure></p>
<h1 id="&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;"><a href="#&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;" class="headerlink" title="&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;"></a>&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;</h1><p>&#x5F3A;/&#x5F31;&#x6307;&#x9488;&#x628A;&#x6211;&#x6298;&#x817E;&#x7684;&#x4E03;&#x8364;&#x516B;&#x7D20;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x539F;&#x578B;&#x53EF;&#x53C2;&#x8003;&#x4E86;&#xFF0C;&#x6211;&#x76F8;&#x4FE1;&#x8FD9;&#x4E2A;&#x8BBE;&#x8BA1;&#x5FC5;&#x6709;&#x51FA;&#x5904;&#xFF0C;&#x53EA;&#x662F;&#x81EA;&#x5DF1;&#x6CA1;&#x6709;&#x627E;&#x5230;&#xFF0C;&#x4E8E;&#x662F;&#x53EA;&#x597D;&#x5543;&#x4EE3;&#x7801;&#x3002;&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4EE3;&#x7801;&#x6BD4;&#x8F7B;&#x91CF;&#x7EA7;&#x667A;&#x80FD;&#x6307;&#x9488;&#x590D;&#x6742;&#x5F88;&#x591A;&#xFF0C;&#x9759;&#x6001;&#x4EE3;&#x7801;&#x7814;&#x7A76;&#x5F88;&#x5BB9;&#x6613;&#x9677;&#x5165;&#x201C;&#x6BCF;&#x53E5;&#x4EE3;&#x7801;&#x90FD;&#x660E;&#x767D;&#xFF0C;&#x5C31;&#x662F;&#x6293;&#x4E0D;&#x4F4F;&#x7075;&#x9B42;&#x201D;&#x7684;&#x5883;&#x5730;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x6700;&#x597D;&#x7684;&#x5E94;&#x5BF9;&#x65B9;&#x6CD5;&#x662F;&#x4ECE;&#x9700;&#x6C42;&#x51FA;&#x53D1;&#xFF0C;&#x627E;&#x5230;&#x4E00;&#x4E24;&#x4E2A;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x4EE3;&#x5165;&#x8D70;&#x67E5;&#x4E00;&#x4E0B;&#x3002;&#x597D;&#x5728;&#x8FD9;&#x5757;&#x4EE3;&#x7801;&#x6BD4;&#x8F83;&#x72EC;&#x7ACB;&#xFF0C;&#x524D;&#x9762;&#x6211;&#x5DF2;&#x7ECF;&#x628A;&#x4ED6;&#x4EEC;&#x62BD;&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x60C5;&#x666F;&#x5206;&#x6790;&#x662F;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7684;&#x3002;</p>
<h2 id="&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x76EE;&#x7684;"><a href="#&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x76EE;&#x7684;" class="headerlink" title="&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x76EE;&#x7684;"></a>&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x76EE;&#x7684;</h2><p>&#x8F7B;&#x91CF;&#x7EA7;&#x667A;&#x80FD;&#x6307;&#x9488;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x5BF9;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x5E76;&#x5728;&#x6CA1;&#x6709;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6307;&#x9488;&#x6307;&#x5411;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x81EA;&#x52A8;&#x9500;&#x6BC1;&#x5BF9;&#x8C61;&#xFF0C;&#x9632;&#x6B62;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;&#x4F46;&#x662F;&#x5F53;&#x9047;&#x5230;&#x5FAA;&#x73AF;&#x5F15;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8BE5;&#x624B;&#x6BB5;&#x5C31;&#x5931;&#x6548;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img04.png" alt="&#x5F53;&#x667A;&#x80FD;&#x6307;&#x9488;&#x9047;&#x4E0A;&#x5FAA;&#x73AF;&#x5F15;&#x7528;"><br>&#x5F53;p&#x4E0D;&#x518D;&#x6307;&#x5411;objectA&#xFF0C;&#x5176;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7531;2&#x53D8;&#x4E3A;1&#xFF0C;&#x76F8;&#x4E92;&#x6307;&#x5411;&#x7684;objectA&#x548C;objectB&#x5C31;&#x53D8;&#x6210;&#x60AC;&#x6D6E;&#x7684;&#x4E24;&#x5EA7;&#x5B64;&#x5C9B;&#xFF0C;&#x518D;&#x4E5F;&#x6CA1;&#x6709;&#x8DEF;&#x5F84;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x5230;&#x5B83;&#x4EEC;&#xFF0C;&#x4E8E;&#x662F;&#x9020;&#x6210;&#x4E86;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;</p>
<p>&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x7ED9;&#x5FAA;&#x73AF;&#x5F15;&#x7528;&#x7684;&#x53CC;&#x65B9;&#x5B9A;&#x4E49;&#x4E3B;&#x4ECE;&#x5173;&#x7CFB;&#xFF0C;&#x7531;&#x4E3B;&#x6307;&#x5411;&#x4ECE;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x5C31;&#x79F0;&#x4E3A;&#x5F3A;&#x6307;&#x9488;&#xFF0C;&#x7531;&#x4ECE;&#x6307;&#x5411;&#x4E3B;&#x7684;&#x6307;&#x9488;&#x5C31;&#x79F0;&#x4E3A;&#x5F31;&#x6307;&#x9488;&#xFF0C;&#x5F3A;/&#x5F31;&#x6307;&#x9488;&#x4ECD;&#x7136;&#x90FD;&#x662F;&#x5177;&#x5907;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x529F;&#x80FD;&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#xFF0C;&#x53EA;&#x662F;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x6CA1;&#x6709;&#x5F3A;&#x6307;&#x9488;&#x6307;&#x5411;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x53EF;&#x4EE5;&#x9500;&#x6BC1;&#x6389;&#x4E86;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img05.png" alt="&#x5F3A;&#x5F31;&#x6307;&#x9488;&#x89E3;&#x51B3;&#x5FAA;&#x73AF;&#x5F15;&#x7528;&#x7684;&#x95EE;&#x9898;"><br>&#x5B9E;&#x7EBF;&#x4EE3;&#x8868;&#x5F3A;&#x6307;&#x9488;&#xFF0C;&#x865A;&#x7EBF;&#x4EE3;&#x8868;&#x5F31;&#x6307;&#x9488;&#x3002;&#x5F53;p&#x4E0D;&#x518D;&#x6307;&#x5411;objectA&#xFF0C;&#x5176;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x4E3A;0&#xFF0C;&#x4E8E;&#x662F;objectA&#x53EF;&#x4EE5;&#x9500;&#x6BC1;&#xFF0C;&#x5B83;&#x6307;&#x5411;objectB&#x7684;&#x5F3A;&#x6307;&#x9488;&#x4E5F;&#x88AB;&#x9500;&#x6BC1;&#xFF0C;&#x4E8E;&#x662F;objectB&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x4E3A;0&#xFF0C;objectB&#x4E5F;&#x53EF;&#x4EE5;&#x9500;&#x6BC1;&#x3002;</p>
<h2 id="&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4F7F;&#x7528;"><a href="#&#x5F3A;-&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4F7F;&#x7528;"></a>&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x4F7F;&#x7528;</h2><p>&#x5F3A;/&#x5F31;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7684;&#x5B9A;&#x4E49;&#x548C;&#x4F7F;&#x7528;&#x5F62;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x5BF9;&#x8C61;&#x5B9E;&#x4F53;&#x5FC5;&#x987B;&#x4ECE;RefBase&#x6D3E;&#x751F;&#xFF0C;&#x8BE5;&#x7C7B;&#x5728;`RefBase.h`&#x548C;`RefBase.cpp`&#x4E2D;&#x58F0;&#x660E;&#x548C;&#x5B9A;&#x4E49;</span></span><br><span class="line"><span class="keyword">class</span> MyClass : <span class="keyword">public</span> RefBase</span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">};</span><br><span class="line">......</span><br><span class="line">sp&lt;MyClass&gt; pStrong(new MyClass);   <span class="comment">// &#x5B9A;&#x4E49;&#x5F3A;&#x6307;&#x9488;</span></span><br><span class="line">wp&lt;MyClass&gt; pWeak(new MyClass);     <span class="comment">// &#x5B9A;&#x4E49;&#x5F31;&#x6307;&#x9488;</span></span><br></pre></td></tr></table></figure></p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;RefBase&#xFF0C;frameworks/rs/cpp/util/RefBase.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> RefBase</span><br><span class="line">{</span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> weakref_type</span><br><span class="line">    {</span><br><span class="line">        ........</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span>                 ~RefBase();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> {</span><br><span class="line">        OBJECT_LIFETIME_STRONG  = <span class="number">0x0000</span>,</span><br><span class="line">        OBJECT_LIFETIME_WEAK    = <span class="number">0x0001</span>,</span><br><span class="line">        OBJECT_LIFETIME_MASK    = <span class="number">0x0001</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">class</span> weakref_impl;</span><br><span class="line">        </span><br><span class="line">    weakref_impl* <span class="keyword">const</span> mRefs;</span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<p>&#x548C;LightRefBase&#x76F8;&#x6BD4;&#x6709;&#x4E09;&#x4E2A;&#x660E;&#x663E;&#x7684;&#x5DEE;&#x5F02;&#xFF1A;</p>
<ol>
<li>&#x6CA1;&#x6709;&#x6A21;&#x677F;&#x53C2;&#x6570;&#xFF0C;&#x524D;&#x6587;&#x5DF2;&#x7ECF;&#x5206;&#x6790;&#x8FC7;LightRefBase&#x4F7F;&#x7528;&#x6A21;&#x677F;&#x53C2;&#x6570;&#x662F;&#x51FA;&#x4E8E;&#x6027;&#x80FD;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x7701;&#x53BB;&#x4E00;&#x4E2A;&#x865A;&#x8868;&#x7684;&#x5F00;&#x9500;&#xFF0C;&#x800C;RefBase&#x5B9A;&#x4E49;&#x4E86;virtual&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x89C1;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x6240;&#x96BE;&#x514D;&#x7684;&#xFF0C;&#x4E8E;&#x662F;&#x518D;&#x7528;&#x6A21;&#x677F;&#x53C2;&#x6570;&#x5C31;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x610F;&#x4E49;&#x4E86;&#x3002;</li>
<li>RefBase&#x6CA1;&#x6709;&#x50CF;LightRefBase&#x90A3;&#x6837;&#x76F4;&#x63A5;&#x7528;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x8BB0;&#x5F55;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x800C;&#x662F;&#x53C8;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;weakref_impl<em>&#x7C7B;&#x578B;&#x7684;&#x6210;&#x5458;&#xFF0C;&#x7531;&#x5B83;&#x6765;&#x8BB0;&#x5F55;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x3002;&#x8FD9;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#xFF1F;&#x4ECE;&#x524D;&#x9762;&#x6A21;&#x578B;&#x56FE;&#x4E0A;&#x5C31;&#x80FD;&#x627E;&#x5230;&#x7B54;&#x6848;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img05.png" alt="&#x5F3A;&#x5F31;&#x6307;&#x9488;&#x89E3;&#x51B3;&#x5FAA;&#x73AF;&#x5F15;&#x7528;&#x7684;&#x95EE;&#x9898;"><br>&#x7EE7;&#x7EED;&#x524D;&#x9762;&#x7684;&#x63A8;&#x6F14;&#xFF0C;objectA&#x88AB;&#x9500;&#x6BC1;&#x540E;&#xFF0C;objectB&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x5F31;&#x6307;&#x9488;&#x6307;&#x5411;objectA&#x7684;&#x3002;objectA&#x5728;&#x9500;&#x6BC1;&#x7684;&#x65F6;&#x523B;&#xFF0C;&#x53EA;&#x80FD;&#x5904;&#x7406;&#x7531;&#x81EA;&#x5DF1;&#x53D1;&#x51FA;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x800C;&#x65E0;&#x6CD5;&#x77E5;&#x9053;&#x90FD;&#x6709;&#x8C01;&#x6307;&#x5411;&#x4E86;&#x81EA;&#x5DF1;&#x3002;&#x4E8E;&#x662F;objectA&#x88AB;&#x9500;&#x6BC1;&#x540E;&#xFF0C;&#x6765;&#x81EA;objectB&#x7684;&#x5F31;&#x6307;&#x9488;&#x4E5F;&#x5C31;&#x6210;&#x4E86;&#x91CE;&#x6307;&#x9488;&#x3002;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x548C;&#x5BF9;&#x8C61;&#x5B9E;&#x4F53;&#x5206;&#x79BB;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img06.png" alt="&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E0E;&#x5BF9;&#x8C61;&#x5B9E;&#x4F53;&#x5206;&#x79BB;"><br>&#x4E8E;&#x662F;&#x5C31;&#x6709;&#x4E86;weakref_impl</em> mRefs&#x6210;&#x5458;&#xFF0C;&#x8BE5;&#x6210;&#x5458;&#x88AB;&#x79F0;&#x4E3A;&#x4ED6;&#x6240;&#x8BB0;&#x5F55;&#x7684;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#xFF0C;&#x5F71;&#x5B50;&#x548C;&#x672C;&#x5C0A;&#x4E4B;&#x95F4;&#x6709;&#x6307;&#x9488;&#x6307;&#x5411;&#x5BF9;&#x65B9;&#xFF0C;&#x4F46;&#x5F71;&#x5B50;&#x7684;&#x751F;&#x5B58;&#x5468;&#x671F;&#x53EF;&#x80FD;&#x6BD4;&#x672C;&#x5C0A;&#x8FD8;&#x8981;&#x957F;&#x3002;&#x56E0;&#x4E3A;&#x5F71;&#x5B50;&#x8D1F;&#x8D23;&#x8BB0;&#x5F55;&#x672C;&#x5C0A;&#x7684;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5F53;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0&#x65F6;&#xFF0C;&#x672C;&#x5C0A;&#x88AB;&#x9500;&#x6BC1;&#xFF0C;&#x5F71;&#x5B50;&#x7EE7;&#x7EED;&#x8BB0;&#x5F55;&#x5176;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x76F4;&#x5230;&#x4E24;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5206;&#x522B;&#x4E3A;0&#xFF0C;&#x5F71;&#x5B50;&#x624D;&#x88AB;&#x9500;&#x6BC1;&#x6389;&#x3002;</li>
<li>&#x679A;&#x4E3E;&#x7C7B;&#x578B;OBJECT_LIFETIME_xxx&#x3002;&#x8FD9;&#x672C;&#x4E0D;&#x7B97;&#x548C;LightRefBase&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#xFF0C;&#x4F46;&#x5728;&#x9605;&#x8BFB;RefBase&#x4EE3;&#x7801;&#x65F6;&#x8FD9;&#x4E09;&#x79CD;&#x7C7B;&#x578B;&#x5DE6;&#x53F3;&#x7740;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7B56;&#x7565;&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x6700;&#x8BA9;&#x6211;&#x7591;&#x60D1;&#x7684;&#x5730;&#x65B9;&#xFF1A;&#x65E2;&#x7136;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x51B3;&#x5B9A;&#x5B9E;&#x4F53;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD8;&#x8981;&#x5728;reakref_impl&#x4E2D;&#x7528;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x53D8;&#x91CF;mFlags&#x6765;&#x8BB0;&#x5F55;&#x5B9E;&#x4F53;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x53D7;&#x54EA;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x63A7;&#x5236;&#x5462;&#xFF1F;&#x8BD5;&#x60F3;&#x5982;&#x4E0B;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF1A;<br><img src="/blog/2016/06/10/2016/0610BinderLearning11/img07.png" alt=""><br>&#x5F53;p1&#x4E0D;&#x518D;&#x6307;&#x5411;objectA&#xFF0C;&#x5B83;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5C31;&#x4E3A;0&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x53EF;&#x4EE5;&#x88AB;&#x9500;&#x6BC1;&#x3002;&#x53EF;&#x6B64;&#x65F6;&#x8FD8;&#x6709;p2&#x6307;&#x5411;objectB&#xFF0C;&#x4E24;&#x4E2A;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5E76;&#x6CA1;&#x6709;&#x6210;&#x4E3A;&#x5B64;&#x5C9B;&#xFF0C;&#x8FD8;&#x6709;&#x53EF;&#x80FD;&#x8981;&#x901A;&#x8FC7;p2&#x518D;&#x8BBF;&#x95EE;objectA&#x548C;objectB&#x7EC4;&#x6210;&#x7684;&#x5FAA;&#x73AF;&#x94FE;&#x8868;&#xFF0C;&#x5728;objectA&#x548C;objectB&#x4E4B;&#x95F4;&#x5B9A;&#x4E49;&#x4E3B;&#x4ECE;&#x5173;&#x7CFB;&#x4EC5;&#x4EC5;&#x662F;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x5B64;&#x5C9B;&#x5BFC;&#x81F4;&#x7684;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;&#x6240;&#x4EE5;&#x5C3D;&#x7BA1;objectA&#x6B64;&#x65F6;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5DF2;&#x4E3A;0&#xFF0C;&#x53EA;&#x8981;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x8FD8;&#x5728;&#xFF0C;&#x8FD8;&#x662F;&#x5148;&#x7559;objectA&#x4E00;&#x6761;&#x5C0F;&#x547D;&#xFF0C;&#x8BA9;&#x5B83;&#x518D;&#x82DF;&#x5EF6;&#x6B8B;&#x5598;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x76F4;&#x5230;&#x5176;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E5F;&#x4E3A;0&#xFF0C;&#x8BF4;&#x660E;&#x5F7B;&#x5E95;&#x6CA1;&#x7528;&#x4E86;&#xFF0C;&#x5230;&#x90A3;&#x65F6;&#x5019;&#x518D;&#x771F;&#x5730;&#x5E72;&#x6389;&#x3002;&#x8FD9;&#x5C31;&#x662F;mFlags&#x548C;&#x8FD9;&#x4E09;&#x4E2A;&#x679A;&#x4E3E;&#x7C7B;&#x578B;&#x7684;&#x4F5C;&#x7528;&#xFF1A;<ul>
<li>&#x5F53;mFlags&#x4E3A;OBJECT_LIFETIME_STRONG&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x9075;&#x5FAA;&#x5F3A;/&#x5F31;&#x6307;&#x9488;&#x6700;&#x521D;&#x59CB;&#x7684;&#x89C4;&#x5219;&#xFF1A;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0&#xFF0C;&#x5C31;&#x9500;&#x6BC1;&#xFF1B;</li>
<li>&#x5F53;mFlags&#x4E3A;OBJECT_LIFETIME_WEAK&#xFF0C;&#x5982;&#x679C;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x6682;&#x65F6;&#x4E0D;&#x8981;&#x9500;&#x6BC1;&#xFF0C;&#x7B49;&#x5230;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E5F;&#x4E3A;0&#x65F6;&#x518D;&#x9500;&#x6BC1;</li>
</ul>
</li>
</ol>
<h2 id="&#x60C5;&#x666F;&#x5206;&#x6790;-1"><a href="#&#x60C5;&#x666F;&#x5206;&#x6790;-1" class="headerlink" title="&#x60C5;&#x666F;&#x5206;&#x6790;"></a>&#x60C5;&#x666F;&#x5206;&#x6790;</h2><h3 id="&#x6784;&#x9020;sp&#x5BF9;&#x8C61;&#x548C;wp&#x5BF9;&#x8C61;"><a href="#&#x6784;&#x9020;sp&#x5BF9;&#x8C61;&#x548C;wp&#x5BF9;&#x8C61;" class="headerlink" title="&#x6784;&#x9020;sp&#x5BF9;&#x8C61;&#x548C;wp&#x5BF9;&#x8C61;"></a>&#x6784;&#x9020;sp&#x5BF9;&#x8C61;&#x548C;wp&#x5BF9;&#x8C61;</h3><p>&#x5728;smartptr.cpp&#x4E2D;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tc03</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> <span class="comment">// &#x6D4B;&#x8BD5;sp&#x8F6C;&#x4E3A;wp</span></span><br><span class="line"></span>{</span><br><span class="line">    return testSWPtr(argc, argv);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>testweightptr.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">testSWPtr</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> * argv[])</span></span><br><span class="line"></span>{</span><br><span class="line">    WeightClass* pObj = new WeightClass();  <span class="comment">// &#x521B;&#x5EFA;RefBase&#x5BF9;&#x8C61;&#x5B9E;&#x4F53;</span></span><br><span class="line">    sp&lt;WeightClass&gt; spObj(pObj);            <span class="comment">// &#x7528;&#x5F3A;&#x6307;&#x9488;&#x6307;&#x5411;&#x8BE5;&#x5B9E;&#x4F53;</span></span><br><span class="line">    spObj-&gt;printRefCount();</span><br><span class="line">    wp&lt;WeightClass&gt; wpObj(spObj);           <span class="comment">// &#x7528;&#x5F31;&#x6307;&#x9488;&#x6307;&#x5411;&#x5F3A;&#x6307;&#x9488;</span></span><br><span class="line">    spObj-&gt;printRefCount();</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h4 id="RefBase&#x6784;&#x9020;&#x51FD;&#x6570;"><a href="#RefBase&#x6784;&#x9020;&#x51FD;&#x6570;" class="headerlink" title="RefBase&#x6784;&#x9020;&#x51FD;&#x6570;"></a>RefBase&#x6784;&#x9020;&#x51FD;&#x6570;</h4><p>WeightClass&#x7EE7;&#x627F;&#x81EA;RefBase&#xFF0C;&#x5176;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RefBase::RefBase() </span><br><span class="line">    : mRefs(new weakref_impl(this))  <span class="comment">// RefBase&#x5BF9;&#x8C61;&#x5728;&#x521B;&#x5EFA;&#x7684;&#x540C;&#x65F6;&#x4F1A;&#x4E3A;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;</span></span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;RefBase::RefBase()&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x6784;&#x9020;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">weakref_impl(RefBase* base) <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x5F3A;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;mBase&#x6307;&#x5411;&#x672C;&#x5C0A;&#x5B8C;&#x6210;&#x4E92;&#x6307;</span></span><br><span class="line">    : mStrong(INITIAL_STRONG_VALUE)</span><br><span class="line">    , mWeak(<span class="number">0</span>)</span><br><span class="line">    , mBase(base)</span><br><span class="line">    , mFlags(<span class="number">0</span>)</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;RefBase::weakref_impl::weakref_impl(RefBase* base)&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p><strong> &#x56E0;&#x6B64;&#xFF0C;&#x6784;&#x9020;&#x4E00;&#x4E2A;RefBase&#x5BF9;&#x8C61;&#x5B8C;&#x6210;&#x7684;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#xFF0C;&#x521B;&#x5EFA;&#x8D1F;&#x8D23;&#x7EF4;&#x62A4;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x5F3A;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5E76;&#x5B8C;&#x6210;&#x672C;&#x5C0A;&#x548C;&#x5F71;&#x5B50;&#x7684;&#x4E92;&#x6307;&#x3002;</strong></p>
<h4 id="sp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;"><a href="#sp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;" class="headerlink" title="sp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;"></a>sp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;</h4><p>&#x56DE;&#x5230;<code>testSWPtr(...)</code>&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;<code>sp&lt;WeightClass&gt; spObj(pObj);</code>&#x6267;&#x884C;sp&#x7684;&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sp(T* other): m_ptr(other)</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;sp::sp(T*)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (other) other-&gt;incStrong(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5B83;&#x4F1A;&#x589E;&#x52A0;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5373;RefBase::incStrong(&#x2026;)&#x3002;RefBase.cpp:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::incStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">{</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;incWeak(id);  <span class="comment">// &#x7D2F;&#x52A0;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></span><br><span class="line">    </span><br><span class="line">    refs-&gt;addStrongRef(id); <span class="comment">// &#x5FFD;&#x7565;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_inc(&amp;refs-&gt;mStrong);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c != INITIAL_STRONG_VALUE)  {</span><br><span class="line">        return;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    android_atomic_add(-INITIAL_STRONG_VALUE, &amp;refs-&gt;mStrong);</span><br><span class="line">    refs-&gt;mBase-&gt;onFirstRef();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>weakref_impl&#x7684;&#x5B9A;&#x4E49;&#x5728;RefBase.cpp&#x4E2D;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x5806;&#x7A7A;&#x51FD;&#x6570;&#xFF0C;&#x5728;Debug&#x7248;&#x672C;&#x4E2D;&#x7528;&#x4E8E;&#x8C03;&#x8BD5;&#xFF0C;&#x56E0;&#x6B64;&#x9047;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">renameStrongRefId</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*old_id*/</span>, <span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*new_id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addWeakRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeWeakRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">renameWeakRefId</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*old_id*/</span>, <span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*new_id*/</span>)</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printRefs</span><span class="params">()</span> <span class="keyword">const</span> </span>{ }</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trackMe</span><span class="params">(<span class="keyword">bool</span>, <span class="keyword">bool</span>)</span> </span>{ }</span><br></pre></td></tr></table></figure></p>
<p><code>RefBase::inStrong(...)</code>&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x5E72;&#x4E86;&#x4E09;&#x4EF6;&#x4E8B;&#xFF1A;</p>
<ol>
<li><p>&#x7D2F;&#x52A0;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5176;&#x8C03;&#x7528;&#x5F88;&#x7B80;&#x5355;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::weakref_type::incWeak(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span><br><span class="line">{</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> impl = <span class="keyword">static_cast</span>&lt;weakref_impl*&gt;(this);</span><br><span class="line">    impl-&gt;addWeakRef(id); <span class="comment">// &#x5FFD;&#x7565;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c __unused = android_atomic_inc(&amp;impl-&gt;mWeak);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#x7D2F;&#x52A0;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x3002;<br>&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5728;&#x6784;&#x9020;&#x7684;&#x65F6;&#x5019;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x4E3A;INITIAL_STRONG_VALUE&#xFF0C;&#x8868;&#x793A;&#x201C;&#x6211;&#x662F;&#x5904;&#x201D;&#xFF01;&#x8FD9;&#x662F;&#x4E2A;&#x4E0D;&#x53EF;&#x80FD;&#x8FBE;&#x5230;&#x7684;&#x6781;&#x5927;&#x5E38;&#x91CF;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x7D2F;&#x52A0;&#x540E;&#x4F1A;&#x628A;&#x8BE5;&#x5E38;&#x91CF;&#x51CF;&#x6389;</p>
</li>
<li>&#x5982;&#x679C;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7834;&#x5904;&#xFF0C;&#x901A;&#x77E5;&#x672C;&#x5C0A;&#xFF0C;&#x5141;&#x8BB8;&#x5B83;&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x65F6;&#x505A;&#x4E00;&#x4E9B;&#x548C;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x76F8;&#x5173;&#x7684;&#x4E8B;&#x60C5;</li>
</ol>
<p>&#x95EE;&#x9898;&#x6765;&#x4E86;&#xFF1A;&#x660E;&#x660E;&#x662F;incStrong(&#x2026;)&#xFF0C;&#x589E;&#x52A0;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FDE;&#x5E26;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E00;&#x8D77;&#x52A0;&#x5462;&#xFF1F;&#x8C01;&#x80FD;&#x544A;&#x8BC9;&#x6211;&#x7B54;&#x6848;&#xFF1F;<br>&#x6211;&#x7684;&#x731C;&#x6D4B;&#x662F;&#x9171;&#x7D2B;&#x6EF4;&#xFF1A;&#x4E3B;&#x8981;&#x51FA;&#x4E8E;&#x7B80;&#x5316;&#x903B;&#x8F91;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x524D;&#x6587;&#x5206;&#x6790;&#x8FC7;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5F53;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;0&#x5C31;&#x53EF;&#x4EE5;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4E86;&#xFF0C;&#x6B64;&#x65F6;&#x5F71;&#x5B50;&#x8FD8;&#x4E0D;&#x80FD;&#x9500;&#x6BC1;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD8;&#x8981;&#x7EF4;&#x62A4;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x76F4;&#x5230;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;0&#x624D;&#x53EF;&#x4EE5;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF1A;</p>
<blockquote>
<p>&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x63A7;&#x5236;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x63A7;&#x5236;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x53E5;&#x8BDD;&#x7684;&#x63CF;&#x8FF0;&#x663E;&#x7136;&#x6BD4;&#x4E0A;&#x4E00;&#x6BB5;&#x7B80;&#x6D01;&#xFF0C;&#x8F6C;&#x6362;&#x6210;&#x4EE3;&#x7801;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x4E24;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x9500;&#x6BC1;&#x53EA;&#x770B;&#x5355;&#x4E00;&#x53D8;&#x91CF;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#xFF0C;&#x7531;&#x6B64;&#x5E26;&#x6765;&#x7684;&#x4EE3;&#x4EF7;&#x5C31;&#x662F;&#x8981;&#x5728;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7D2F;&#x52A0;&#x7684;&#x540C;&#x65F6;&#x4E5F;&#x8981;&#x7D2F;&#x52A0;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x3002;&#x4F60;&#x53EF;&#x80FD;&#x4F1A;&#x89C9;&#x5F97;&#x6839;&#x636E;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#x51B3;&#x5B9A;&#x5F71;&#x5B50;&#x7684;&#x9500;&#x6BC1;&#x7B56;&#x7565;&#x5E76;&#x6CA1;&#x6709;&#x5F15;&#x5165;&#x592A;&#x5927;&#x7684;&#x590D;&#x6742;&#x5EA6;&#xFF0C;&#x53EF;&#x662F;&#x8FD8;&#x6709;&#x7B2C;&#x4E09;&#x4E2A;&#x53D8;&#x91CF;mFlags&#xFF0C;&#x7EA0;&#x7F20;&#x5728;&#x4E00;&#x8D77;&#x4E8B;&#x60C5;&#x5C31;&#x53D8;&#x5F97;&#x9EBB;&#x70E6;&#x5F88;&#x591A;&#xFF0C;&#x540E;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x4F1A;&#x9047;&#x5230;&#x3002;&#x6211;&#x8BA4;&#x4E3A;&#x8FD9;&#x4E2A;deal&#x662F;&#x975E;&#x5E38;&#x5212;&#x7B97;&#x7684;&#x3002;</p>
<p><strong> &#x56E0;&#x6B64;sp&#x7684;&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#xFF1A;&#x521D;&#x59CB;&#x5316;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x6307;&#x9488;&#xFF0C;&#x5C06;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x52A0;1&#xFF0C;&#x5E76;&#x5141;&#x8BB8;&#x5176;&#x7B2C;&#x4E00;&#x6B21;&#x88AB;&#x5F3A;&#x5F15;&#x7528;&#x65F6;&#x63D2;&#x5165;&#x4E1A;&#x52A1;&#x903B;&#x8F91; </strong></p>
<h4 id="wp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;"><a href="#wp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;" class="headerlink" title="wp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;"></a>wp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;</h4><p>&#x56DE;&#x5230;<code>testSWPtr(...)</code>&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;<code>wp&lt;WeightClass&gt; wpObj(spObj);</code>&#x6267;&#x884C;wp&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">wp&lt;T&gt;::wp(<span class="keyword">const</span> sp&lt;T&gt;&amp; other)</span><br><span class="line">    : m_ptr(other.m_ptr)</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;wp::wp(const sp&lt;T&gt;&amp; other)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (m_ptr) {</span><br><span class="line">        m_refs = m_ptr-&gt;createWeak(this);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6267;&#x884C;&#x4E86;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5373;RefBase&#x7684;createWeak(&#x2026;)&#x51FD;&#x6570;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RefBase::weakref_type* RefBase::createWeak(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">{</span><br><span class="line">    mRefs-&gt;incWeak(id); <span class="comment">// &#x524D;&#x9762;&#x9047;&#x5230;&#x8FC7;&#x8FD9;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x5C31;&#x662F;&#x5C06;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7D2F;&#x52A0;1</span></span><br><span class="line">    return mRefs;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p><strong> wp&#x7684;&#x62F7;&#x8D1D;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x5C06;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7D2F;&#x52A0;1&#xFF0C;&#x7136;&#x540E;&#x628A;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F71;&#x5B50;&#x4EA4;&#x7ED9;&#x81EA;&#x5DF1;&#x7684;m_refs&#x6210;&#x5458;&#x3002; </strong><br>&#x6211;&#x4EEC;&#x6765;&#x6BD4;&#x8F83;&#x4E00;&#x4E0B;sp&#x548C;wp&#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#xFF0C;sp&#x53EA;&#x6709;&#x4E00;&#x4E2A;m_ptr&#xFF0C;&#x4EE3;&#x8868;&#x5B83;&#x6240;&#x6307;&#x5411;&#x7684;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;wp&#x6709;&#x4E24;&#x4E2A;&#xFF1A;m_ptr&#x548C;m_refs&#x3002;&#x524D;&#x8005;&#x662F;&#x5B83;&#x6240;&#x6307;&#x5411;&#x7684;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x540E;&#x8005;&#x662F;&#x8BE5;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x3002;&#x524D;&#x9762;&#x8BF4;&#x8FC7;&#xFF0C;&#x672C;&#x5C0A;&#x548C;&#x5F71;&#x5B50;&#x4E4B;&#x95F4;&#x662F;&#x4E92;&#x6307;&#x7684;&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x5C31;&#x80FD;&#x627E;&#x5230;&#x53E6;&#x4E00;&#x4E2A;&#xFF0C;&#x4F46;&#x662F;&#x672C;&#x5C0A;&#x53EF;&#x80FD;&#x6BD4;&#x5F71;&#x5B50;&#x66F4;&#x65E9;&#x5730;&#x88AB;&#x9500;&#x6BC1;&#x6389;&#xFF0C;&#x56E0;&#x6B64;&#x5F31;&#x6307;&#x9488;wp&#x4EC5;&#x4FDD;&#x5B58;m_ptr&#x662F;&#x4E0D;&#x591F;&#x7684;&#xFF0C;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x4FDD;&#x5B58;&#x5176;&#x5F71;&#x5B50;&#xFF1B;&#x800C;&#x5F3A;&#x6307;&#x9488;&#x5219;&#x4E0D;&#x5FC5;&#xFF0C;&#x56E0;&#x4E3A;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;0&#xFF0C;m_ptr&#x88AB;&#x9500;&#x6BC1;&#xFF0C;&#x5F3A;&#x6307;&#x9488;&#x4E5F;&#x5C31;&#x6CA1;&#x6709;&#x5B58;&#x5728;&#x7684;&#x610F;&#x4E49;&#x4E86;&#x3002;</p>
<p>&#x6784;&#x9020;&#x90E8;&#x5206;&#x5C31;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x9690;&#x85CF;&#x7684;&#x6790;&#x6784;&#x90E8;&#x5206;&#x3002;</p>
<h4 id="wp&#x6790;&#x6784;&#x51FD;&#x6570;"><a href="#wp&#x6790;&#x6784;&#x51FD;&#x6570;" class="headerlink" title="wp&#x6790;&#x6784;&#x51FD;&#x6570;"></a>wp&#x6790;&#x6784;&#x51FD;&#x6570;</h4><p>&#x9996;&#x5148;&#x88AB;&#x6790;&#x6784;&#x7684;&#x662F;wp&#xFF0C;RefBase.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">wp&lt;T&gt;::~wp()</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;wp::~wp()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (m_ptr) m_refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x7EE7;&#x7EED;&#x8FFD;&#x8E2A;RefBase.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::weakref_type::decWeak(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span><br><span class="line">{</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> impl = <span class="keyword">static_cast</span>&lt;weakref_impl*&gt;(this);</span><br><span class="line">    impl-&gt;removeWeakRef(id);  <span class="comment">// &#x5FFD;&#x7565;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;impl-&gt;mWeak); <span class="comment">// &#x9012;&#x51CF;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">1</span>) return;</span><br><span class="line">    <span class="comment">// &#x5982;&#x679C;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x51CF;&#x5230;0</span></span><br><span class="line">    <span class="keyword">if</span> ((impl-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) == OBJECT_LIFETIME_STRONG) {</span><br><span class="line">                <span class="comment">// &#x4E00;&#x822C;&#x903B;&#x8F91;</span></span><br><span class="line">        <span class="comment">// This is the regular lifetime case. The object is destroyed</span></span><br><span class="line">        <span class="comment">// when the last strong reference goes away. Since weakref_impl</span></span><br><span class="line">        <span class="comment">// outlive the object, it is not destroyed in the dtor, and</span></span><br><span class="line">        <span class="comment">// we&apos;ll have to do it here.</span></span><br><span class="line">        <span class="keyword">if</span> (impl-&gt;mStrong == INITIAL_STRONG_VALUE) {</span><br><span class="line">            <span class="comment">// Special case: we never had a strong reference, so we need to</span></span><br><span class="line">            <span class="comment">// destroy the object now.</span></span><br><span class="line">            <span class="keyword">delete</span> impl-&gt;mBase;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// ALOGV(&quot;Freeing refs %p of old RefBase %p\n&quot;, this, impl-&gt;mBase);</span></span><br><span class="line">            <span class="keyword">delete</span> impl;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {    <span class="comment">// &#x6682;&#x5B58;&#x903B;&#x8F91;</span></span><br><span class="line">        <span class="comment">// less common case: lifetime is OBJECT_LIFETIME_{WEAK|FOREVER}</span></span><br><span class="line">        impl-&gt;mBase-&gt;onLastWeakRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((impl-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_WEAK) {</span><br><span class="line">            <span class="comment">// this is the OBJECT_LIFETIME_WEAK case. The last weak-reference</span></span><br><span class="line">            <span class="comment">// is gone, we can destroy the object.</span></span><br><span class="line">            <span class="keyword">delete</span> impl-&gt;mBase;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5982;&#x679C;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x6839;&#x636E;mFlags&#x6765;&#x5206;&#x522B;&#x5904;&#x7406;&#x4E86;&#xFF0C;&#x4E0D;&#x8BB0;&#x5F97;OBJECT_LIFETIME_xxx&#x7684;&#x70B9;&#x53F3;&#x4FA7;&#x7684;&#x706B;&#x7BAD;&#x4E0A;&#x697C;&#x590D;&#x4E60;:)</p>
<ul>
<li>mFlags&#x4E3A;OBJECT_LIFETIME_STRONG&#x5C31;&#x662F;&#x4E00;&#x822C;&#x903B;&#x8F91;&#xFF0C;&#x5373;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x51CF;&#x5230;0&#x65F6;&#x7ACB;&#x5373;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#x4E5F;&#x5C31;&#x610F;&#x5473;&#x7740;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E5F;&#x5FC5;&#x4E3A;0&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;0&#x6709;&#x4E24;&#x79CD;&#x53EF;&#x80FD;&#xFF1A;1&#x3001;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4ECE;&#x672A;&#x88AB;&#x7834;&#x5904;&#x8FC7;&#xFF0C;&#x5373;<code>impl-&gt;mStrong == INITIAL_STRONG_VALUE</code>&#x4E3A;&#x771F;&#xFF0C;&#x6B64;&#x65F6;&#x9700;&#x8981;&#x9500;&#x6BC1;&#x6389;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF1B;2&#x3001;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;&#x4E86;0&#xFF0C;&#x90A3;&#x4E48;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x6B64;&#x65F6;&#x80AF;&#x5B9A;&#x5DF2;&#x7ECF;&#x4E0D;&#x5B58;&#x5728;&#x4E86;&#xFF08;&#x56E0;&#x4E3A;&#x5728;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#x7684;&#x65F6;&#x523B;&#x5DF2;&#x7ECF;&#x88AB;&#x9500;&#x6BC1;&#x4E86;&#xFF09;&#xFF0C;&#x6B64;&#x65F6;&#x53EA;&#x9700;&#x8981;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x3002;</li>
<li><code>(impl-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) == OBJECT_LIFETIME_STRONG</code>&#x975E;&#x771F;&#x5219;&#x662F;&#x7F13;&#x5B58;&#x903B;&#x8F91;&#xFF0C;&#x5373;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4F1A;&#x88AB;&#x7F13;&#x5B58;&#x76F4;&#x5230;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E5F;&#x9012;&#x51CF;&#x5230;0&#x624D;&#x9500;&#x6BC1;&#x3002;&#x4E0E;onFirstRef()&#x7C7B;&#x4F3C;&#xFF0C;&#x5728;&#x88AB;&#x9500;&#x6BC1;&#x6389;&#x4E4B;&#x524D;&#x6709;&#x673A;&#x4F1A;&#x8BA9;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x6267;&#x884C;&#x4E00;&#x628A;&#x4E1A;&#x52A1;&#x903B;&#x8F91;onLastWeakRef(&#x2026;)&#xFF0C;&#x7136;&#x540E;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x3002;&#x6211;&#x8BA4;&#x4E3A;&#x8FD9;&#x91CC;&#x9762;&#x7684;if&#x8BED;&#x53E5;&#x662F;&#x591A;&#x4F59;&#x4E86;&#xFF0C;&#x5B83;&#x6709;&#x975E;&#x771F;&#x7684;&#x53EF;&#x80FD;&#x5417;&#xFF1F;</li>
</ul>
<p>&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6B64;&#x5904;&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x903B;&#x8F91;&#x5206;&#x652F;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;impl&#x4E86;&#xFF0C;&#x800C;&#x6CA1;&#x6709;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5206;&#x652F;&#x9700;&#x8981;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x5462;&#xFF1F;&#x8FD9;&#x4E0D;&#x4F1A;&#x9020;&#x6210;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x6CC4;&#x9732;&#x5417;&#xFF1F;</p>
<p>&#x7B54;&#x6848;&#x9690;&#x85CF;&#x5728;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;RefBase&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#x4E2D;&#xFF0C;RefBase.cpp&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RefBase::~RefBase()</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;RefBase::~RefBase()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mRefs-&gt;mStrong == INITIAL_STRONG_VALUE) {</span><br><span class="line">        <span class="comment">// we never acquired a strong (and/or weak) reference on this object.</span></span><br><span class="line">        <span class="keyword">delete</span> mRefs;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// &#x6682;&#x5B58;&#x903B;&#x8F91;</span></span><br><span class="line">        <span class="comment">// life-time of this object is extended to WEAK or FOREVER, in</span></span><br><span class="line">        <span class="comment">// which case weakref_impl doesn&apos;t out-live the object and we</span></span><br><span class="line">        <span class="comment">// can free it now.</span></span><br><span class="line">        <span class="keyword">if</span> ((mRefs-&gt;mFlags &amp; OBJECT_LIFETIME_MASK) != OBJECT_LIFETIME_STRONG) {</span><br><span class="line">            <span class="comment">// It&apos;s possible that the weak count is not 0 if the object</span></span><br><span class="line">            <span class="comment">// re-acquired a weak reference in its destructor</span></span><br><span class="line">            <span class="keyword">if</span> (mRefs-&gt;mWeak == <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">delete</span> mRefs;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// for debugging purposes, clear this.</span></span><br><span class="line">    <span class="keyword">const_cast</span>&lt;weakref_impl*&amp;&gt;(mRefs) = <span class="literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x8BE5;&#x6790;&#x6784;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x8D1F;&#x8D23;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#xFF1A;</p>
<ul>
<li>&#x5F53;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4ECE;&#x672A;&#x88AB;&#x5F3A;&#x6307;&#x9488;&#x6307;&#x5411;&#x8FC7;&#xFF0C;&#x90A3;&#x53EA;&#x6709;&#x4E24;&#x79CD;&#x53EF;&#x80FD;&#xFF1A;<ul>
<li>&#x672A;&#x88AB;&#x5F31;&#x6307;&#x9488;&#x6307;&#x5411;&#x8FC7;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8DDF;&#x667A;&#x80FD;&#x6307;&#x9488;&#x6CA1;&#x5173;&#x7CFB;&#x4E86;&#xFF0C;&#x5B83;&#x5728;&#x6784;&#x9020;&#x7684;&#x65F6;&#x5019;&#x521B;&#x5EFA;&#x4E86;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#xFF0C;&#x6790;&#x6784;&#x65F6;&#x5F53;&#x7136;&#x8981;&#x8D1F;&#x8D23;&#x9500;&#x6BC1;</li>
<li>&#x88AB;&#x5F31;&#x6307;&#x9488;&#x6307;&#x5411;&#x8FC7;&#xFF0C;&#x6B64;&#x65F6;&#x7684;&#x6790;&#x6784;&#x5FC5;&#x7136;&#x662F;&#x56E0;&#x4E3A;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;&#x4E86;0&#x800C;&#x5BFC;&#x81F4;&#xFF0C;decWeak(&#x2026;)&#x6CA1;&#x6709;&#x8D1F;&#x8D23;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x5C31;&#x5FC5;&#x987B;&#x8981;&#x505A;</li>
</ul>
</li>
<li>&#x6216;&#x8005;&#x5728;&#x6682;&#x5B58;&#x903B;&#x8F91;&#x4E0B;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;0&#xFF0C;&#x5219;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x3002;</li>
</ul>
<p>&#x56DE;&#x5230;&#x524D;&#x9762;&#x7684;<code>void RefBase::weakref_type::decWeak(const void* id)</code>&#xFF0C;<br>&#x5F53;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#xFF1A;</p>
<ul>
<li>&#x5728;&#x4E00;&#x822C;&#x903B;&#x8F91;&#x4E0B;<ul>
<li>&#x5982;&#x679C;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x672A;&#x88AB;&#x7834;&#x5904;&#xFF1A;&#x5219;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x5BF9;&#x8C61;&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#x53C8;&#x4F1A;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;</li>
<li>&#x5426;&#x5219;&#x4E5F;&#x5C31;&#x610F;&#x5473;&#x7740;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x88AB;&#x9012;&#x51CF;&#x5230;&#x4E86;0&#xFF0C;&#x5F53;&#x65F6;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5C31;&#x88AB;&#x9500;&#x6BC1;&#x4E86;&#xFF0C;&#x4F46;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E0D;&#x4E3A;0&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x8C61;&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#x4E0D;&#x4F1A;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#xFF0C;&#x6B64;&#x65F6;&#x9700;&#x8981;&#x628A;&#x5F71;&#x5B50;&#x9500;&#x6BC1;&#x6389;</li>
</ul>
</li>
<li>&#x5728;&#x6682;&#x5B58;&#x903B;&#x8F91;&#x4E0B;&#xFF0C;&#x8BA9;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x8BF4;&#x51E0;&#x53E5;&#x9057;&#x8A00;&#xFF0C;&#x7136;&#x540E;&#x9500;&#x6BC1;&#x4E4B;&#xFF0C;&#x5BF9;&#x8C61;&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#x53C8;&#x4F1A;&#x9500;&#x6BC1;&#x6389;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;</li>
</ul>
<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x804C;&#x8D23;&#x4F18;&#x5148;&#x7531;RefBase&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;&#x6765;&#x505A;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x5408;&#x60C5;&#x5408;&#x7406;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x662F;&#x7531;RefBase&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x7684;&#x3002;&#x4EC5;&#x5F53;RefBase&#x6790;&#x6784;&#x51FD;&#x6570;&#x65E0;&#x6CD5;&#x5B8C;&#x6210;&#x9500;&#x6BC1;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5373;RefBase&#x5148;&#x4E8E;&#x5F71;&#x5B50;&#x9500;&#x6BC1;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x4EA4;&#x7ED9;decWeak(&#x2026;)&#x51FD;&#x6570;&#x5728;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;0&#x7684;&#x65F6;&#x5019;&#x5B8C;&#x6210;&#x9500;&#x6BC1;&#x3002;</p>
<p>&#x4EE5;&#x4E0A;&#x662F;wp&#x6790;&#x6784;&#x51FD;&#x6570;&#x7684;&#x5B8C;&#x6574;&#x5206;&#x6790;&#xFF0C;&#x4E0D;&#x8FC7;&#x7ED3;&#x5408;tc03&#x5B9E;&#x4F8B;&#xFF0C;wp&#x6790;&#x6784;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5E76;&#x4E3A;&#x9012;&#x51CF;&#x5230;0&#xFF0C;&#x56E0;&#x6B64;<code>void RefBase::weakref_type::decWeak(const void* id)</code>&#x4EC5;&#x4EC5;&#x5C06;&#x5176;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x9012;&#x51CF;&#x5230;1&#xFF0C;&#x5728;&#x7B2C;#6&#x884C;&#x5C31;&#x8FD4;&#x56DE;&#x4E86;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x5219;&#x662F;sp&#x7684;&#x6790;&#x6784;&#x3002;</p>
<h4 id="sp&#x6790;&#x6784;&#x51FD;&#x6570;"><a href="#sp&#x6790;&#x6784;&#x51FD;&#x6570;" class="headerlink" title="sp&#x6790;&#x6784;&#x51FD;&#x6570;"></a>sp&#x6790;&#x6784;&#x51FD;&#x6570;</h4><p>StrongPointer.h:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~sp()</span><br><span class="line">{</span><br><span class="line">    Logging(<span class="string">&quot;sp::~sp()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (m_ptr) m_ptr-&gt;decStrong(<span class="keyword">this</span>); <span class="comment">// &#x9012;&#x51CF;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x7EE7;&#x7EED;&#x8FFD;&#x8E2A;RefBase.cpp:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">{</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;removeStrongRef(id);  <span class="comment">// &#x5FFD;&#x7565;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) {</span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="comment">// &#x4E00;&#x822C;&#x903B;&#x8F91;</span></span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p><code>decStrong(...)</code>&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x4E24;&#x4EF6;&#x4E8B;&#xFF1A;</p>
<ul>
<li>&#x9012;&#x51CF;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x4E00;&#x822C;&#x903B;&#x8F91;&#xFF0C;&#x5F53;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x51CF;&#x5230;0&#x5219;&#x9500;&#x6BC1;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;</li>
<li>&#x9012;&#x51CF;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E5F;&#x9012;&#x51CF;&#x5230;0&#xFF0C;&#x4E5F;&#x4F1A;&#x5F15;&#x53D1;&#x4E00;&#x5806;&#x9500;&#x6BC1;&#x5904;&#x7406;&#xFF0C;&#x524D;&#x6587;&#x5DF2;&#x7ECF;&#x5206;&#x6790;&#x8FC7;&#x4E86;<br>&#x7ED3;&#x5408;&#x672C;&#x4F8B;&#xFF0C;&#x5230;&#x6B64;&#x65F6;&#x5F3A;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x624D;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#xFF0C;&#x5728;decWeak(&#x2026;)&#x4E2D;&#x624D;&#x6267;&#x884C;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;&#x7684;&#x9500;&#x6BC1;&#x3002;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x662F;tc03&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#xFF1A;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./smartptr tc03</span><br><span class="line">[RefBase.cpp:25] RefBase::weakref_impl::weakref_impl(RefBase* base)</span><br><span class="line">[RefBase.cpp:315] RefBase::RefBase()</span><br><span class="line">[StrongPointer.h:41] sp::sp(T*)</span><br><span class="line">[StrongPointer.h:73] sp::operator-&gt;()</span><br><span class="line">[testweightptr.cpp:17] StrongCount=1. WeakCount=1.</span><br><span class="line">[RefBase.h:274] wp::wp(const sp&lt;T&gt;&amp; other)</span><br><span class="line">[StrongPointer.h:73] sp::operator-&gt;()</span><br><span class="line">[testweightptr.cpp:17] StrongCount=1. WeakCount=2.</span><br><span class="line">[RefBase.h:312] wp::~wp()</span><br><span class="line">[StrongPointer.h:53] sp::~sp()</span><br><span class="line">[RefBase.cpp:320] RefBase::~RefBase()</span><br></pre></td></tr></table></figure></p>
<p>&#x5C3D;&#x7BA1;&#x53EA;&#x5206;&#x6790;&#x4E86;&#x4E00;&#x4E2A;&#x7528;&#x4F8B;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x5DF2;&#x7ECF;&#x628A;Android&#x7684;&#x667A;&#x80FD;&#x6307;&#x9488;&#x7814;&#x7A76;&#x5F97;&#x5F88;&#x900F;&#x5F7B;&#x4E86;&#xFF0C;&#x4E5F;&#x63ED;&#x5F00;&#x4E86;&#x4E4B;&#x524D;&#x770B;binder&#x4EE3;&#x7801;&#x7684;&#x4E00;&#x4E9B;&#x7591;&#x56E2;&#x3002;&#x5982;&#x679C;&#x672C;&#x5468;&#x8FD8;&#x6709;&#x65F6;&#x95F4;&#xFF0C;&#x6211;&#x4F1A;&#x518D;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x5F31;&#x6307;&#x9488;&#x7531;&#x5F31;&#x5347;&#x5F3A;&#x7684;<code>wp::promte()</code>&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x5B9E;&#x4E5F;&#x4E0D;&#x8FC7;&#x662F;&#x524D;&#x9762;&#x83B7;&#x5F97;&#x7684;&#x8BA4;&#x77E5;&#x7684;&#x7EFC;&#x5408;&#x8FD0;&#x7528;&#x800C;&#x5DF2;&#xFF0C;&#x6CA1;&#x6709;&#x592A;&#x65B0;&#x9C9C;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<p>&#x82E6;&#x82E6;&#x8FFD;&#x5BFB;&#x4E86;&#x4E00;&#x4E2A;&#x793C;&#x62DC;&#xFF0C;&#x4ECA;&#x665A;&#x7EC8;&#x4E8E;&#x53EF;&#x4EE5;&#x7761;&#x4E2A;&#x8E0F;&#x5B9E;&#x89C9;&#x5566;&#x3002;<br>&#x6700;&#x540E;&#x518D;&#x6C89;&#x6DC0;&#x51E0;&#x53E5;&#x9E21;&#x6C64;&#xFF1A;&#x8BFB;&#x4EE3;&#x7801;&#x4E0D;&#x8981;&#x4E00;&#x5934;&#x624E;&#x5F97;&#x592A;&#x6DF1;&#xFF0C;&#x521D;&#x671F;&#x89C2;&#x5176;&#x5927;&#x7565;&#x4E86;&#x89E3;&#x610F;&#x56FE;&#x6700;&#x91CD;&#x8981;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x8BF4;&#x8D77;&#x6765;&#x5BB9;&#x6613;&#xFF0C;&#x5982;&#x679C;&#x4EE3;&#x7801;&#x91CF;&#x5927;&#x4E00;&#x4E9B;&#xFF0C;&#x628A;&#x201C;&#x5927;&#x7565;&#x201D;&#x88C5;&#x5230;&#x809A;&#x5B50;&#x91CC;&#x4E5F;&#x633A;&#x8003;&#x9A8C;&#x80BA;&#x6D3B;&#x91CF;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x4E0A;&#x73ED;&#x7D2F;&#x5F97;&#x50CF;&#x72D7;&#x4E00;&#x6837;&#xFF0C;&#x53EA;&#x80FD;&#x6BCF;&#x665A;&#x4E00;&#x4E24;&#x4E2A;&#x5C0F;&#x65F6;&#x6765;&#x641E;&#x3002;&#x628A;&#x5F53;&#x5929;&#x7814;&#x7A76;&#x7684;&#x5185;&#x5BB9;&#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#xFF0C;&#x505A;&#x6709;&#x6548;&#x7684;&#x6C89;&#x6DC0;&#x5F88;&#x91CD;&#x8981;&#xFF0C;&#x6211;&#x7528;hexo&#x7684;draft&#x6765;&#x6682;&#x5B58;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x5C3D;&#x91CF;&#x6269;&#x5C55;&#x81EA;&#x5DF1;&#x7684;&#x89C6;&#x91CE;&#xFF0C;&#x8BB2;&#x7A76;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x662F;&#x6700;&#x61C2;&#x5F97;&#x4E0D;&#x91CD;&#x590D;&#x9020;&#x8F6E;&#x5B50;&#x7684;&#xFF0C;&#x4E00;&#x6765;&#x6210;&#x719F;&#x7684;&#x4E1C;&#x897F;&#x7A33;&#x5B9A;&#xFF1B;&#x4E8C;&#x6765;&#x6A21;&#x5F0F;&#x964D;&#x4F4E;&#x4E86;&#x5B66;&#x4E60;&#x548C;&#x4EA4;&#x6D41;&#x6C9F;&#x901A;&#x7684;&#x6210;&#x672C;&#x3002;</p>
<hr>
<p>&#x4ECA;&#x665A;&#x518D;&#x6DFB;&#x6700;&#x540E;&#x4E00;&#x7B14;&#xFF0C;&#x667A;&#x80FD;&#x6307;&#x9488;&#x5C31;&#x9F50;&#x6D3B;&#x4E86;&#xFF01;</p>
<h3 id="wp-promote-&#x5F31;&#x6307;&#x9488;&#x5347;&#x683C;&#x4E3A;&#x5F3A;&#x6307;&#x9488;"><a href="#wp-promote-&#x5F31;&#x6307;&#x9488;&#x5347;&#x683C;&#x4E3A;&#x5F3A;&#x6307;&#x9488;" class="headerlink" title="wp::promote()&#x5F31;&#x6307;&#x9488;&#x5347;&#x683C;&#x4E3A;&#x5F3A;&#x6307;&#x9488;"></a>wp::promote()&#x5F31;&#x6307;&#x9488;&#x5347;&#x683C;&#x4E3A;&#x5F3A;&#x6307;&#x9488;</h3><p>&#x5728;RefBase.h:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt; wp&lt;T&gt;::promote() <span class="keyword">const</span></span><br><span class="line">{</span><br><span class="line">    sp&lt;T&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (m_ptr &amp;&amp; m_refs-&gt;attemptIncStrong(&amp;result)) {</span><br><span class="line">        result.set_pointer(m_ptr);</span><br><span class="line">    }</span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>RefBase.cpp:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> RefBase::weakref_type::attemptIncStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span><br><span class="line">{</span><br><span class="line">    incWeak(id);  <span class="comment">// &#x589E;&#x52A0;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></span><br><span class="line">    </span><br><span class="line">    weakref_impl* <span class="keyword">const</span> impl = <span class="keyword">static_cast</span>&lt;weakref_impl*&gt;(this);</span><br><span class="line">    <span class="keyword">int32_t</span> curCount = impl-&gt;mStrong;</span><br><span class="line">    <span class="comment">// &#x5F53;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5DF2;&#x7834;&#x5904;&#xFF0C;&#x4E14;&#x5927;&#x4E8E;0&#xFF1A;&#x7ED9;impl-&gt;mStrong&#x9012;&#x52A0;1&#xFF0C;&#x5E76;&#x5C06;&#x9012;&#x52A0;&#x540E;&#x7684;&#x503C;&#x8D4B;&#x7ED9;curCount</span></span><br><span class="line">    <span class="keyword">while</span> (curCount &gt; <span class="number">0</span> &amp;&amp; curCount != INITIAL_STRONG_VALUE) {</span><br><span class="line">        <span class="comment">// we&apos;re in the easy/common case of promoting a weak-reference</span></span><br><span class="line">        <span class="comment">// from an existing strong reference.</span></span><br><span class="line">        <span class="keyword">if</span> (android_atomic_cmpxchg(curCount, curCount+<span class="number">1</span>, &amp;impl-&gt;mStrong) == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// the strong count has changed on us, we need to re-assert our</span></span><br><span class="line">        <span class="comment">// situation.</span></span><br><span class="line">        curCount = impl-&gt;mStrong;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &#x5F53;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x672A;&#x7834;&#x5904;&#x6216;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#xFF1A;</span></span><br><span class="line">    <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span> || curCount == INITIAL_STRONG_VALUE) {</span><br><span class="line">        <span class="comment">// we&apos;re now in the harder case of either:</span></span><br><span class="line">        <span class="comment">// - there never was a strong reference on us</span></span><br><span class="line">        <span class="comment">// - or, all strong references have been released</span></span><br><span class="line">        <span class="comment">// &#x4E00;&#x822C;&#x903B;&#x8F91;</span></span><br><span class="line">        <span class="keyword">if</span> ((impl-&gt;mFlags&amp;OBJECT_LIFETIME_WEAK) == OBJECT_LIFETIME_STRONG) {</span><br><span class="line">            <span class="comment">// this object has a &quot;normal&quot; life-time, i.e.: it gets destroyed</span></span><br><span class="line">            <span class="comment">// when the last strong reference goes away</span></span><br><span class="line">            <span class="comment">// &#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5DF2;&#x88AB;&#x9012;&#x51CF;&#x5230;0&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x80AF;&#x5B9A;&#x5DF2;&#x88AB;&#x9500;&#x6BC1;&#xFF0C;&#x65E0;&#x6CD5;&#x5347;&#x683C;&#xFF0C;&#x8FD8;&#x539F;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;</span></span><br><span class="line">            <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// the last strong-reference got released, the object cannot</span></span><br><span class="line">                <span class="comment">// be revived.</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                return <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// &#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x5927;&#x4E8E;0&#xFF0C;&#x8BD5;&#x56FE;&#x9012;&#x52A0;1&#xFF0C;&#x5E76;&#x5C06;&#x9012;&#x52A0;&#x540E;&#x7684;&#x503C;&#x8D4B;&#x7ED9;curCount</span></span><br><span class="line">            <span class="comment">// here, curCount == INITIAL_STRONG_VALUE, which means</span></span><br><span class="line">            <span class="comment">// there never was a strong-reference, so we can try to</span></span><br><span class="line">            <span class="comment">// promote this object; we need to do that atomically.</span></span><br><span class="line">            <span class="keyword">while</span> (curCount &gt; <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (android_atomic_cmpxchg(curCount, curCount + <span class="number">1</span>,</span><br><span class="line">                        &amp;impl-&gt;mStrong) == <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// the strong count has changed on us, we need to re-assert our</span></span><br><span class="line">                <span class="comment">// situation (e.g.: another thread has inc/decStrong&apos;ed us)</span></span><br><span class="line">                curCount = impl-&gt;mStrong;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// &#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x201C;&#x8BD5;&#x56FE;&#x9012;&#x52A0;&#x201D;&#x5931;&#x8D25;&#xFF0C;&#x88AB;&#x522B;&#x7684;&#x7EBF;&#x7A0B;&#x9012;&#x51CF;&#x56DE;0&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x80AF;&#x5B9A;&#x4E5F;&#x6CA1;&#x4E86;&#xFF0C;&#x53EA;&#x80FD;&#x8FD4;&#x56DE;</span></span><br><span class="line">            <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// promote() failed, some other thread destroyed us in the</span></span><br><span class="line">                <span class="comment">// meantime (i.e.: strong count reached zero).</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                return <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {  <span class="comment">// &#x6682;&#x5B58;&#x903B;&#x8F91;&#x4E0B;&#xFF0C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x603B;&#x662F;&#x5B58;&#x5728;&#x7684;</span></span><br><span class="line">            <span class="comment">// this object has an &quot;extended&quot; life-time, i.e.: it can be</span></span><br><span class="line">            <span class="comment">// revived from a weak-reference only.</span></span><br><span class="line">            <span class="comment">// Ask the object&apos;s implementation if it agrees to be revived</span></span><br><span class="line">            &#x5982;&#x679C;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4E0D;&#x5141;&#x8BB8;&#x5C1D;&#x8BD5;&#x9012;&#x589E;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x5931;&#x8D25;</span><br><span class="line">            <span class="keyword">if</span> (!impl-&gt;mBase-&gt;onIncStrongAttempted(FIRST_INC_STRONG, id)) {</span><br><span class="line">                <span class="comment">// it didn&apos;t so give-up.</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                return <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// grab a strong-reference, which is always safe due to the</span></span><br><span class="line">            <span class="comment">// extended life-time.</span></span><br><span class="line">            curCount = android_atomic_inc(&amp;impl-&gt;mStrong);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the strong reference count has already been incremented by</span></span><br><span class="line">        <span class="comment">// someone else, the implementor of onIncStrongAttempted() is holding</span></span><br><span class="line">        <span class="comment">// an unneeded reference.  So call onLastStrongRef() here to remove it.</span></span><br><span class="line">        <span class="comment">// (No, this is not pretty.)  Note that we MUST NOT do this if we</span></span><br><span class="line">        <span class="comment">// are in fact acquiring the first reference.</span></span><br><span class="line">        <span class="keyword">if</span> (curCount &gt; <span class="number">0</span> &amp;&amp; curCount &lt; INITIAL_STRONG_VALUE) {</span><br><span class="line">            impl-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    impl-&gt;addStrongRef(id);  <span class="comment">//&#x5FFD;&#x7565;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#x5982;&#x679C;&#x524D;&#x9762;&#x7684;&#x9012;&#x52A0;&#x4F7F;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7834;&#x5904;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x6E05;&#x7406;&#x6389;&#x5904;&#x5973;&#x819C;</span></span><br><span class="line">    <span class="comment">// now we need to fix-up the count if it was INITIAL_STRONG_VALUE</span></span><br><span class="line">    <span class="comment">// this must be done safely, i.e.: handle the case where several threads</span></span><br><span class="line">    <span class="comment">// were here in attemptIncStrong().</span></span><br><span class="line">    curCount = impl-&gt;mStrong;</span><br><span class="line">    <span class="keyword">while</span> (curCount &gt;= INITIAL_STRONG_VALUE) {</span><br><span class="line">        <span class="keyword">if</span> (android_atomic_cmpxchg(curCount, curCount-INITIAL_STRONG_VALUE,</span><br><span class="line">                &amp;impl-&gt;mStrong) == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// the strong-count changed on us, we need to re-assert the situation,</span></span><br><span class="line">        <span class="comment">// for e.g.: it&apos;s possible the fix-up happened in another thread.</span></span><br><span class="line">        curCount = impl-&gt;mStrong;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p><code>RefBase::weakref_type::attemptIncStrong(const void* id)</code>&#x7684;&#x903B;&#x8F91;&#x5E76;&#x4E0D;&#x590D;&#x6742;&#xFF0C;&#x6838;&#x5FC3;&#x76EE;&#x6807;&#x5C31;&#x662F;&#x5C1D;&#x8BD5;&#x7ED9;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x6307;&#x9488;&#x9012;&#x52A0;1&#x3002;&#x4F46;&#x6709;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x6CE8;&#x5B9A;&#x4E0D;&#x53EF;&#x80FD;&#x5B8C;&#x6210;&#x4EFB;&#x52A1;&#x7684;&#xFF0C;&#x6BD4;&#x5982;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5DF2;&#x7ECF;&#x88AB;&#x9500;&#x6BC1;&#x4E86;&#xFF1B;&#x6216;&#x8005;&#x5728;&#x6267;&#x884C;&#x6B64;&#x51FD;&#x6570;&#x7684;&#x65F6;&#x5019;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x8FD8;&#x5728;&#xFF0C;&#x4F46;&#x5728;&#x6267;&#x884C;&#x9012;&#x52A0;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x88AB;&#x9500;&#x6BC1;&#x4E86;&#xFF1B;&#x6216;&#x8005;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x62D2;&#x7EDD;&#x88AB;&#x5347;&#x683C;&#x3002;&#x8FD9;&#x4E9B;&#x60C5;&#x51B5;&#x8FD4;&#x56DE;false&#x3002;</p>
</div><script type="text/javascript" src="/blog/js/share.js?v=0.0.0" async></script><a data-url="http://palanceli.github.io/blog/2016/06/10/2016/0610BinderLearning11/" data-id="cirks1szh001brbzij23a02ij" class="article-share-link">分享到</a><div class="tags"><a href="/blog/tags/binder/">binder</a></div><div class="post-nav"><a href="/blog/2016/06/14/2016/0614BinderLearning12/" class="pre">Binder学习笔记（十二）—— binder_transaction(...)都干了什么？</a><a href="/blog/2016/05/28/2016/0528BinderLearning10/" class="next">binder学习笔记（十）—— 穿越到驱动层</a></div><div id="disqus_thread"><script>var disqus_shortname = 'palance';
var disqus_identifier = '2016/06/10/2016/0610BinderLearning11/';
var disqus_title = 'Binder学习笔记（十一）—— 智能指针';
var disqus_url = 'http://palanceli.github.io/2016/06/10/2016/0610BinderLearning11/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//palance.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://palanceli.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Excel使用/">Excel使用</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/环境、配置/">环境、配置</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/生活/">生活</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/深度探索binder/" style="font-size: 15px;">深度探索binder</a> <a href="/blog/tags/binder/" style="font-size: 15px;">binder</a> <a href="/blog/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/blog/tags/音乐/" style="font-size: 15px;">音乐</a> <a href="/blog/tags/Excel使用/" style="font-size: 15px;">Excel使用</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2016/08/07/2016/0807DissectingBinder3/">深度探索Binder（三）查找服务</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/08/06/2016/0806DissectingBinder2/">深度探索Binder（二）注册服务</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/08/01/2016/0801Excel/">Excel使用</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/28/2016/0728DissectingBinder1/">深度探索Binder（一）取款机模型</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/24/2016/0724BinderLearning14/">binder学习笔记（十四）—— binder_thread_read(...)都干了什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/17/2016/0717抓到一只小乌龟/">今天抓到一只小乌龟</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/09/2016/0709BinderLearning13/">Binder学习笔记（十三）—— 小结</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/06/14/2016/0614BinderLearning12/">Binder学习笔记（十二）—— binder_transaction(...)都干了什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/06/10/2016/0610BinderLearning11/">Binder学习笔记（十一）—— 智能指针</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/28/2016/0528BinderLearning10/">binder学习笔记（十）—— 穿越到驱动层</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//palance.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/palanceli" title="我的GitHub" target="_blank">我的GitHub</a><ul></ul><a href="http://www.cnblogs.com/palance/" title="我的博客园" target="_blank">我的博客园</a><ul></ul><a href="http://blog.csdn.net/zchongr" title="我的CSDN" target="_blank">我的CSDN</a><ul></ul><a href="http://www.jianshu.com/users/5e527164a8c2" title="我的简书" target="_blank">我的简书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/blog/." rel="nofollow">Palance's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/blog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/blog/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=0.0.0"></script></div></body></html>